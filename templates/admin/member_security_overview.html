{% extends "base.html" %}
{% set use_v2_design = True %}

{% block title %}Sicherheitsübersicht - Admin{% endblock %}

{% block content %}
<div class="container">
    <nav class="breadcrumbs" aria-label="Breadcrumb">
        <div class="breadcrumbs__item">
            <a href="{{ url_for('admin.index') }}" class="breadcrumbs__link">Admin</a>
            <span class="breadcrumbs__separator">/</span>
        </div>
        <div class="breadcrumbs__item">
            <a href="{{ url_for('admin.members') }}" class="breadcrumbs__link">Mitglieder</a>
            <span class="breadcrumbs__separator">/</span>
        </div>
        <div class="breadcrumbs__item">
            <span class="breadcrumbs__current">Sicherheitsübersicht</span>
        </div>
    </nav>

    <div class="page-header">
        <h1>
            <svg class="icon" aria-hidden="true"><use href="/static/icons/lucide-sprite.svg#shield"></use></svg>
            Sicherheitsübersicht
        </h1>
        <p class="page-subtitle">Mitglied: {{ member.display_name_with_spirit }}</p>
    </div>
    
    <div class="page-content">
        <div class="card">
            <div class="card__header"><h2 class="card__title">Mitglied-Informationen</h2></div>
            <div class="card__body">
                <div class="info-row"><span class="info-row__label">Name</span><span class="info-row__value">{{ member.display_name_with_spirit }}</span></div>
                <div class="info-row"><span class="info-row__label">E-Mail</span><span class="info-row__value">{{ member.email }}</span></div>
                <div class="info-row"><span class="info-row__label">Status</span>
                    <span class="info-row__value">
                        {% if member.is_active %}<span class="chip chip--success">Aktiv</span>{% else %}<span class="chip chip--danger">Inaktiv</span>{% endif %}
                    </span>
                </div>
                <div class="info-row"><span class="info-row__label">Rolle</span>
                    <span class="info-row__value">
                        {% if member.role.value == 'admin' %}<span class="chip chip--accent">Admin</span>{% else %}<span class="chip chip--info">Mitglied</span>{% endif %}
                    </span>
                </div>
            </div>
        </div>
        
        <div class="card">
            <div class="card__header"><h2 class="card__title">2FA-Status</h2></div>
            <div class="card__body" style="display: flex; flex-direction: column; gap: var(--space-3);">
                {% if mfa_data and mfa_data.is_totp_enabled %}
                    <div class="card-section card-section--subtle">
                        <div class="card-section__body" style="display:flex; gap: var(--space-3); align-items: flex-start;">
                            <span class="chip chip--success">2FA aktiviert</span>
                            <div style="color: var(--color-text-secondary); display:flex; flex-direction:column; gap: 4px;">
                                <span>Aktiviert: {{ mfa_data.activated_at.strftime('%d.%m.%Y %H:%M') if mfa_data.activated_at else 'Unbekannt' }}</span>
                                {% if mfa_data.last_verified_at %}<span>Zuletzt verifiziert: {{ mfa_data.last_verified_at.strftime('%d.%m.%Y %H:%M') }}</span>{% endif %}
                            </div>
                        </div>
                    </div>
                    
                    <div class="card-section card-section--subtle">
                        <div class="card-section__header">
                            <h3 class="card-section__title">Backup-Codes</h3>
                        </div>
                        <div class="card-section__body">
                            <p>Verfügbare Backup-Codes: <strong>{{ unused_backup_codes|length }}</strong> von 10</p>
                            {% if unused_backup_codes %}
                            <p class="text-muted">Erste 3 Codes (gehashed, gekürzt): 
                                {% for code in unused_backup_codes[:3] %}
                                    <code>{{ code.code_hash[:8] }}...</code>{% if not loop.last %}, {% endif %}
                                {% endfor %}
                            </p>
                            {% else %}
                            <p class="text-warning">Keine Backup-Codes verfügbar</p>
                            {% endif %}
                        </div>
                    </div>
                {% else %}
                    <div class="card-section card-section--subtle">
                        <div class="card-section__body" style="display:flex; gap: var(--space-3); align-items: center;">
                            <span class="chip chip--danger">2FA deaktiviert</span>
                            <span class="text-muted">Keine 2FA eingerichtet</span>
                        </div>
                    </div>
                {% endif %}
            </div>
        </div>
        
        <div class="card">
            <div class="card__header"><h2 class="card__title">Letzte Sicherheits-Events</h2></div>
            <div class="card__body" style="display:flex; flex-direction:column; gap: var(--space-3); max-height: 320px; overflow:auto;">
                {% if recent_events %}
                    {% for event in recent_events %}
                    <div class="card-section card-section--subtle">
                        <div class="card-section__header" style="display:flex; justify-content: space-between; align-items: center;">
                            <span class="card-section__title">{{ event.display_action }}</span>
                            <span class="text-muted">{{ event.at.strftime('%d.%m.%Y %H:%M') }}</span>
                        </div>
                        {% if event.extra_json %}
                        <div class="card-section__body">
                            <small class="text-muted">
                                {% if event.extra_json.ip %}IP: {{ event.extra_json.ip }}{% endif %}
                                {% if event.extra_json.admin_id %}{% if event.extra_json.ip %} · {% endif %}Admin-ID: {{ event.extra_json.admin_id }}{% endif %}
                            </small>
                        </div>
                        {% endif %}
                    </div>
                    {% endfor %}
                {% else %}
                    <p class="text-muted">Keine Sicherheits-Events gefunden.</p>
                {% endif %}
            </div>
        </div>
        
        <div class="card">
            <div class="card__header"><h2 class="card__title">Admin-Aktionen</h2></div>
            <div class="card__body">
                <div class="form-actions" style="flex-wrap: wrap;">
                    <a href="{{ url_for('admin.reset_member_password', member_id=member.id) }}" class="btn btn--danger">
                        <svg class="icon" aria-hidden="true"><use href="/static/icons/lucide-sprite.svg#key"></use></svg>
                        Passwort zurücksetzen
                    </a>
                    <a href="{{ url_for('admin.reset_member_2fa', member_id=member.id) }}" class="btn btn--danger">
                        <svg class="icon" aria-hidden="true"><use href="/static/icons/lucide-sprite.svg#shield-off"></use></svg>
                        2FA zurücksetzen
                    </a>
                </div>
            </div>
        </div>
    </div>
</div>
{% endblock %}
