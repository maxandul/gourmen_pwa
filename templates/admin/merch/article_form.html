{% extends "base.html" %}
{% set use_v2_design = True %}

{% block title %}{{ 'Artikel bearbeiten' if article else 'Neuer Artikel' }} - Gourmen{% endblock %}

{% block content %}
<div class="container">
    <nav class="breadcrumbs" aria-label="Breadcrumb">
        <div class="breadcrumbs__item">
            <a href="{{ url_for('admin.merch') }}" class="breadcrumbs__link">Merch</a>
            <span class="breadcrumbs__separator">/</span>
        </div>
        <div class="breadcrumbs__item">
            <span class="breadcrumbs__current">{{ 'Artikel bearbeiten' if article else 'Neuer Artikel' }}</span>
        </div>
    </nav>

    <div class="page-header">
        <h1>
            <svg class="icon" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" aria-hidden="true">
                <path d="M21 16V8a2 2 0 0 0-1.106-1.789l-7-3.5a2 2 0 0 0-1.788 0l-7 3.5A2 2 0 0 0 3 8v8a2 2 0 0 0 1.106 1.789l7 3.5a2 2 0 0 0 1.788 0l7-3.5A2 2 0 0 0 21 16Z"/>
            </svg>
            {{ 'Artikel bearbeiten' if article else 'Neuer Artikel' }}
        </h1>
        <p class="page-subtitle">Merch-Artikel {{ 'bearbeiten' if article else 'erstellen' }}</p>
    </div>
    
    <div class="page-content">
        <div class="card">
            <div class="card__header">
                <h2 class="card__title">Artikel-Informationen</h2>
            </div>
            <div class="card__body">
                <form method="POST" class="form">
                    <input type="hidden" name="csrf_token" value="{{ csrf_token() }}">

                    <div class="form-field">
                        <label for="name" class="form-field__label">Artikel-Name *</label>
                        <input type="text" 
                               id="name" 
                               name="name" 
                               class="form-field__input" 
                               value="{{ article.name if article else '' }}" 
                               required>
                    </div>
                    
                    <div class="form-field">
                        <label for="description" class="form-field__label">Beschreibung</label>
                        <textarea id="description" 
                                  name="description" 
                                  class="form-field__textarea" 
                                  rows="4">{{ article.description if article else '' }}</textarea>
                    </div>
                    
                    <div class="form-row">
                        <div class="form-field">
                            <label for="base_supplier_price_chf" class="form-field__label">Lieferanten-Preis (CHF) *</label>
                            <input type="number" 
                                   id="base_supplier_price_chf" 
                                   name="base_supplier_price_chf" 
                                   class="form-field__input" 
                                   step="0.01" 
                                   min="0" 
                                   value="{{ '%.2f'|format(article.base_supplier_price_chf) if article else '' }}" 
                                   required>
                            <span class="form-field__hint">Basis-Einkaufspreis vom Lieferanten</span>
                        </div>
                        
                        <div class="form-field">
                            <label for="base_member_price_chf" class="form-field__label">Mitglieder-Preis (CHF) *</label>
                            <input type="number" 
                                   id="base_member_price_chf" 
                                   name="base_member_price_chf" 
                                   class="form-field__input" 
                                   step="0.01" 
                                   min="0" 
                                   value="{{ '%.2f'|format(article.base_member_price_chf) if article else '' }}" 
                                   required>
                            <span class="form-field__hint">Basis-Verkaufspreis für Mitglieder</span>
                        </div>
                    </div>
                    
                    <div class="form-field">
                        <label for="image_url" class="form-field__label">Bild-URL (noch nicht aktiv)</label>
                        <input type="text" 
                               id="image_url" 
                               name="image_url" 
                               class="form-field__input" 
                               value="{{ article.image_url if article else '' }}" 
                               placeholder="https://example.com/image.jpg">
                    </div>
                    
                    <div class="form-field">
                        <label class="form-field__label">Verfügbare Farben *</label>
                        <div id="colors-container">
                            {% if existing_colors %}
                                {% for color in existing_colors %}
                                <div class="form-row form-row--inline-remove" data-type="color">
                                    <div class="form-field">
                                        <input type="text" 
                                               name="colors" 
                                               class="form-field__input" 
                                               value="{{ color }}"
                                               placeholder="z.B. Schwarz"
                                               required>
                                    </div>
                                    <button type="button" class="btn btn--outline btn--sm js-remove" aria-label="Farbe entfernen">
                                        <svg class="icon" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" aria-hidden="true">
                                            <polyline points="3 6 5 6 21 6"/>
                                            <path d="M19 6v14a2 2 0 0 1-2 2H7a2 2 0 0 1-2-2V6"/>
                                            <path d="M10 11v6"/>
                                            <path d="M14 11v6"/>
                                            <path d="M9 6V4a2 2 0 0 1 2-2h2a2 2 0 0 1 2 2v2"/>
                                        </svg>
                                    </button>
                                </div>
                                {% endfor %}
                            {% else %}
                                <div class="form-row form-row--inline-remove" data-type="color">
                                    <div class="form-field">
                                        <input type="text" 
                                               name="colors" 
                                               class="form-field__input" 
                                               placeholder="z.B. Schwarz"
                                               required>
                                    </div>
                                    <button type="button" class="btn btn--outline btn--sm js-remove" aria-label="Farbe entfernen" hidden>
                                        <svg class="icon" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" aria-hidden="true">
                                            <polyline points="3 6 5 6 21 6"/>
                                            <path d="M19 6v14a2 2 0 0 1-2 2H7a2 2 0 0 1-2-2V6"/>
                                            <path d="M10 11v6"/>
                                            <path d="M14 11v6"/>
                                            <path d="M9 6V4a2 2 0 0 1 2-2h2a2 2 0 0 1 2 2v2"/>
                                        </svg>
                                    </button>
                                </div>
                            {% endif %}
                        </div>
                        <button type="button" class="btn btn--outline btn--sm" onclick="addColorInput()">Weitere Farbe hinzufügen</button>
                    </div>
                    
                    <div class="form-field">
                        <label class="form-field__label">Verfügbare Größen *</label>
                        <div id="sizes-container">
                            {% if existing_sizes %}
                                {% for size in existing_sizes %}
                                <div class="form-row form-row--inline-remove" data-type="size">
                                    <div class="form-field">
                                        <input type="text" 
                                               name="sizes" 
                                               class="form-field__input" 
                                               value="{{ size }}"
                                               placeholder="z.B. M"
                                               required>
                                    </div>
                                    <button type="button" class="btn btn--outline btn--sm js-remove" aria-label="Größe entfernen">
                                        <svg class="icon" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" aria-hidden="true">
                                            <polyline points="3 6 5 6 21 6"/>
                                            <path d="M19 6v14a2 2 0 0 1-2 2H7a2 2 0 0 1-2-2V6"/>
                                            <path d="M10 11v6"/>
                                            <path d="M14 11v6"/>
                                            <path d="M9 6V4a2 2 0 0 1 2-2h2a2 2 0 0 1 2 2v2"/>
                                        </svg>
                                    </button>
                                </div>
                                {% endfor %}
                            {% else %}
                                <div class="form-row form-row--inline-remove" data-type="size">
                                    <div class="form-field">
                                        <input type="text" 
                                               name="sizes" 
                                               class="form-field__input" 
                                               placeholder="z.B. M"
                                               required>
                                    </div>
                                    <button type="button" class="btn btn--outline btn--sm js-remove" aria-label="Größe entfernen" hidden>
                                        <svg class="icon" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" aria-hidden="true">
                                            <polyline points="3 6 5 6 21 6"/>
                                            <path d="M19 6v14a2 2 0 0 1-2 2H7a2 2 0 0 1-2-2V6"/>
                                            <path d="M10 11v6"/>
                                            <path d="M14 11v6"/>
                                            <path d="M9 6V4a2 2 0 0 1 2-2h2a2 2 0 0 1 2 2v2"/>
                                        </svg>
                                    </button>
                                </div>
                            {% endif %}
                        </div>
                        <button type="button" class="btn btn--outline btn--sm" onclick="addSizeInput()">Weitere Größe hinzufügen</button>
                    </div>
                    
                    
                    
                    <div class="form-field">
                        <label class="form-field__label">
                            <input type="checkbox" 
                                   id="is_active" 
                                   name="is_active" 
                                   {{ 'checked' if not article or article.is_active else '' }}>
                            Artikel ist aktiv
                        </label>
                        <span class="form-field__hint">Nur aktive Artikel sind für Mitglieder sichtbar</span>
                    </div>
                    
                    <div class="form-actions">
                        <button type="submit" class="btn btn--primary">
                            {{ 'Aktualisieren' if article else 'Erstellen' }}
                        </button>
                        <a href="{{ url_for('admin.merch', tab='articles') }}" class="btn btn--outline">
                            Abbrechen
                        </a>
                    </div>
                </form>
            </div>
        </div>
    </div>
</div>

<script>
function addColorInput() {
    const container = document.getElementById('colors-container');
    const row = document.createElement('div');
    row.className = 'form-row';
    row.setAttribute('data-type', 'color');
    row.innerHTML = `
        <div class="form-field" style="margin-bottom: 0;">
            <input type="text" name="colors" class="form-field__input" placeholder="z.B. Navy" required>
        </div>
        <button type="button" class="btn btn--outline btn--sm js-remove" aria-label="Farbe entfernen">Entfernen</button>
    `;
    container.appendChild(row);
    updateRemoveButtons(container);
}

function addSizeInput() {
    const container = document.getElementById('sizes-container');
    const row = document.createElement('div');
    row.className = 'form-row';
    row.setAttribute('data-type', 'size');
    row.innerHTML = `
        <div class="form-field" style="margin-bottom: 0;">
            <input type="text" name="sizes" class="form-field__input" placeholder="z.B. XL" required>
        </div>
        <button type="button" class="btn btn--outline btn--sm js-remove" aria-label="Größe entfernen">Entfernen</button>
    `;
    container.appendChild(row);
    updateRemoveButtons(container);
}

function updateRemoveButtons(container) {
    const buttons = container.querySelectorAll('.js-remove');
    const show = buttons.length > 1;
    buttons.forEach(btn => {
        btn.hidden = !show ? btn.closest('.form-row').dataset.type ? true : false : false;
        btn.hidden = !show;
    });
}

function removeRow(button) {
    const row = button.closest('.form-row');
    const container = row.parentElement;
    row.remove();
    updateRemoveButtons(container);
}

document.addEventListener('click', (e) => {
    if (e.target.classList.contains('js-remove')) {
        e.preventDefault();
        removeRow(e.target);
    }
});

document.addEventListener('DOMContentLoaded', () => {
    updateRemoveButtons(document.getElementById('colors-container'));
    updateRemoveButtons(document.getElementById('sizes-container'));
});
</script>
{% endblock %}
