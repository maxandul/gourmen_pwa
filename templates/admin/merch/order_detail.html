{% extends "base.html" %}
{% set use_v2_design = True %}

{% block title %}Bestelldetails - Gourmen{% endblock %}

{% block content %}
<div class="container">
    <nav class="breadcrumbs" aria-label="Breadcrumb">
        <div class="breadcrumbs__item">
            <a href="{{ url_for('admin.index') }}" class="breadcrumbs__link">Admin</a>
            <span class="breadcrumbs__separator">/</span>
        </div>
        <div class="breadcrumbs__item">
            <a href="{{ url_for('admin.merch', tab='orders') }}" class="breadcrumbs__link">Merch</a>
            <span class="breadcrumbs__separator">/</span>
        </div>
        <div class="breadcrumbs__item">
            <span class="breadcrumbs__current">Bestelldetail</span>
        </div>
    </nav>

    <div class="page-header">
        <h1>
            <svg class="icon" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" aria-hidden="true"><use href="/static/icons/lucide-sprite.svg#search"></use></svg>
            Bestelldetails
        </h1>
        <p class="page-subtitle">Bestellung #{{ order.order_number }}</p>
    </div>
    
    <div class="page-content">
        <!-- Status-Änderung (eingeklappt) -->
        <div class="card card--filter">
            <div class="card__body">
                <details class="disclosure">
                    <summary class="disclosure__summary">
                        <svg class="icon" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" aria-hidden="true"><use href="/static/icons/lucide-sprite.svg#sliders"></use></svg>
                        Status verwalten
                        <svg class="icon" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" aria-hidden="true">
                            <polyline points="6 9 12 15 18 9"></polyline>
                        </svg>
                    </summary>
                    <div class="disclosure__content">
                        <form method="POST" action="{{ url_for('admin.update_order_status', order_id=order.id) }}" class="form form--inline">
                            <input type="hidden" name="csrf_token" value="{{ csrf_token() }}">
                            <div class="form-row">
                                <div class="form-field">
                                    <label class="form-field__label" for="status">Neuer Status</label>
                                    <select name="status" id="status" class="form-field__select">
                                        <option value="BESTELLT" {% if order.status.value == 'BESTELLT' %}selected{% endif %}>Offen</option>
                                        <option value="WIRD_GELIEFERT" {% if order.status.value == 'WIRD_GELIEFERT' %}selected{% endif %}>Bestellt</option>
                                        <option value="GELIEFERT" {% if order.status.value == 'GELIEFERT' %}selected{% endif %}>Geliefert</option>
                                    </select>
                                </div>
                                <div class="form-field">
                                    <label class="form-field__label">&nbsp;</label>
                                    <button type="submit" class="btn btn--primary">
                                        <svg class="icon" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" aria-hidden="true"><use href="/static/icons/lucide-sprite.svg#check"></use></svg>
                                        Status aktualisieren
                                    </button>
                                </div>
                            </div>
                        </form>
                    </div>
                </details>
            </div>
        </div>

        <!-- Bestellübersicht & Zusammenfassung kombiniert -->
        <div class="card">
            <div class="card__header">
                <h2 class="card__title">
                    <svg class="icon" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" aria-hidden="true"><use href="/static/icons/lucide-sprite.svg#clipboard-list"></use></svg>
                    Bestellübersicht
                </h2>
                <div class="card__actions">
                    {% if order.status.value == 'BESTELLT' %}
                        <span class="chip chip--danger">{{ order.status_display }}</span>
                    {% elif order.status.value == 'WIRD_GELIEFERT' %}
                        <span class="chip chip--warning">{{ order.status_display }}</span>
                    {% elif order.status.value == 'GELIEFERT' %}
                        <span class="chip chip--success">{{ order.status_display }}</span>
                    {% else %}
                        <span class="chip">{{ order.status_display }}</span>
                    {% endif %}
                </div>
            </div>
            <div class="card__body">
                <div class="card-section card-section--subtle">
                    <div class="card-section__body">
                        <div class="info-row">
                            <span class="info-row__label">Bestellnummer</span>
                            <span class="info-row__value">#{{ order.order_number }}</span>
                        </div>
                        <div class="info-row">
                            <span class="info-row__label">Member</span>
                            <span class="info-row__value">{{ order.member.display_name_with_spirit }}</span>
                        </div>
                        <div class="info-row">
                            <span class="info-row__label">Bestellt am</span>
                            <span class="info-row__value">{{ order.created_at.strftime('%d.%m.%Y %H:%M') }}</span>
                        </div>
                        <div class="info-row">
                            <span class="info-row__label">Letzte Aktualisierung</span>
                            <span class="info-row__value">{{ order.updated_at.strftime('%d.%m.%Y %H:%M') }}</span>
                        </div>
                        {% if order.delivered_at %}
                        <div class="info-row">
                            <span class="info-row__label">Geliefert am</span>
                            <span class="info-row__value">{{ order.delivered_at.strftime('%d.%m.%Y %H:%M') }}</span>
                        </div>
                        {% endif %}
                        <div class="info-row">
                            <span class="info-row__label">Anzahl Artikel</span>
                            <span class="info-row__value">{{ order.get_item_count() }} Stück</span>
                        </div>
                        <div class="info-row">
                            <span class="info-row__label">Gesamtbetrag (Member)</span>
                            <span class="info-row__value">{{ "%.2f"|format(order.total_member_price_chf) }} CHF</span>
                        </div>
                        <div class="info-row">
                            <span class="info-row__label">Gesamtbetrag (Lieferant)</span>
                            <span class="info-row__value">{{ "%.2f"|format(order.total_supplier_price_chf) }} CHF</span>
                        </div>
                        <div class="info-row">
                            <span class="info-row__label">Gesamtgewinn</span>
                            <span class="info-row__value">{{ "%.2f"|format(order.total_profit_chf) }} CHF</span>
                        </div>
                    </div>
                </div>
            </div>
        </div>
        
        <!-- Bestellpositionen -->
        <div class="card">
            <div class="card__header">
                <h2 class="card__title">
                    <svg class="icon" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" aria-hidden="true"><use href="/static/icons/lucide-sprite.svg#package"></use></svg>
                    Bestellte Artikel
                </h2>
            </div>
            <div class="card__body">
                {% for item in order.order_items %}
                <div class="card-section card-section--subtle">
                    <div class="card-section__header">
                        <h3 class="card-section__title">{{ item.display_name }}</h3>
                    </div>
                    <div class="card-section__body">
                        <div class="info-row">
                            <span class="info-row__label">Artikel</span>
                            <span class="info-row__value">{{ item.article.name }}</span>
                        </div>
                        <div class="info-row">
                            <span class="info-row__label">Variante</span>
                            <span class="info-row__value">{{ item.variant.color }} {{ item.variant.size }}</span>
                        </div>
                        <div class="info-row">
                            <span class="info-row__label">Anzahl</span>
                            <span class="info-row__value">{{ item.quantity }}x</span>
                        </div>
                        <div class="info-row">
                            <span class="info-row__label">Einzelpreis (Member)</span>
                            <span class="info-row__value">{{ "%.2f"|format(item.unit_member_price_chf) }} CHF</span>
                        </div>
                        <div class="info-row">
                            <span class="info-row__label">Einzelpreis (Lieferant)</span>
                            <span class="info-row__value">{{ "%.2f"|format(item.unit_supplier_price_chf) }} CHF</span>
                        </div>
                        <div class="info-row">
                            <span class="info-row__label">Gesamtpreis (Member)</span>
                            <span class="info-row__value">{{ "%.2f"|format(item.total_member_price_chf) }} CHF</span>
                        </div>
                        <div class="info-row">
                            <span class="info-row__label">Gesamtpreis (Lieferant)</span>
                            <span class="info-row__value">{{ "%.2f"|format(item.total_supplier_price_chf) }} CHF</span>
                        </div>
                        <div class="info-row">
                            <span class="info-row__label">Gewinn</span>
                            <span class="info-row__value">{{ "%.2f"|format(item.total_profit_chf) }} CHF</span>
                        </div>
                    </div>
                </div>
                {% endfor %}
            </div>
        </div>
        
        <!-- Notizen -->
        {% if order.notes %}
        <div class="card">
            <div class="card__header">
                <h2 class="card__title">
                    <svg class="icon" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" aria-hidden="true"><use href="/static/icons/lucide-sprite.svg#note"></use></svg>
                    Notizen
                </h2>
            </div>
            <div class="card__body">
                <div class="card-section card-section--subtle">
                    <div class="card-section__body">
                        <p>{{ order.notes }}</p>
                    </div>
                </div>
            </div>
        </div>
        {% endif %}
    </div>
</div>
{% endblock %}
