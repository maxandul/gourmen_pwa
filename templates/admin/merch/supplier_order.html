{% extends "base.html" %}

{% block title %}Lieferanten-Bestellung - Gourmen{% endblock %}

{% block content %}
<div class="container">
    <div class="page-header">
        <h1>ğŸ“¦ Lieferanten-Bestellung</h1>
        <p class="page-subtitle">Ãœbersicht aller ausstehenden Bestellungen nach Artikel</p>
        <div class="page-actions">
            <a href="{{ url_for('admin.merch_orders') }}" class="btn btn-outline">â† ZurÃ¼ck zu Bestellungen</a>
        </div>
    </div>
    
    <div class="page-content">
        {% if pending_orders_count > 0 %}
            <!-- GesamtÃ¼bersicht -->
            <div class="card">
                <div class="card-header">
                    <h2>ğŸ“Š Gesamtbestellung</h2>
                </div>
                <div class="card-body">
                    <div class="stats-grid">
                        <div class="stats-item">
                            <span class="label">Ausstehende Bestellungen:</span>
                            <span class="value">{{ pending_orders_count }}</span>
                        </div>
                        <div class="stats-item">
                            <span class="label">Artikel:</span>
                            <span class="value">{{ total_stats.article_count }}</span>
                        </div>
                        <div class="stats-item">
                            <span class="label">Varianten:</span>
                            <span class="value">{{ total_stats.variant_count }}</span>
                        </div>
                        <div class="stats-item">
                            <span class="label">GesamtstÃ¼ckzahl:</span>
                            <span class="value">{{ total_stats.total_quantity }} StÃ¼ck</span>
                        </div>
                        <div class="stats-item">
                            <span class="label">Lieferantenpreis:</span>
                            <span class="value">{{ "%.2f"|format(total_stats.total_supplier_price / 100) }} CHF</span>
                        </div>
                        <div class="stats-item">
                            <span class="label">Mitgliederpreis:</span>
                            <span class="value">{{ "%.2f"|format(total_stats.total_member_price / 100) }} CHF</span>
                        </div>
                        <div class="stats-item">
                            <span class="label">Gewinn:</span>
                            <span class="value profit">{{ "%.2f"|format(total_stats.total_profit / 100) }} CHF</span>
                        </div>
                    </div>
                    
                    <div class="action-buttons">
                        <button onclick="copyToClipboard()" class="btn btn-primary">ğŸ“‹ Liste kopieren</button>
                        <form method="POST" action="{{ url_for('admin.mark_orders_as_shipped') }}" style="display: inline;" onsubmit="return confirm('Alle {{ pending_orders_count }} Bestellung(en) als \'Wird geliefert\' markieren?');">
                            <input type="hidden" name="csrf_token" value="{{ csrf_token() }}">
                            <button type="submit" class="btn btn-success">âœ… Als bestellt markieren</button>
                        </form>
                    </div>
                </div>
            </div>
            
            <!-- Artikel-Liste -->
            {% for article_data in articles_data %}
            <div class="card">
                <div class="card-header">
                    <h2>ğŸ·ï¸ {{ article_data.article.name }}</h2>
                    <div class="article-summary">
                        <span class="summary-badge">{{ article_data.total_quantity }} StÃ¼ck</span>
                        <span class="summary-badge">{{ "%.2f"|format(article_data.total_supplier_price / 100) }} CHF</span>
                    </div>
                </div>
                <div class="card-body">
                    <div class="variants-table">
                        <table>
                            <thead>
                                <tr>
                                    <th>Farbe</th>
                                    <th>GrÃ¶ÃŸe</th>
                                    <th>Anzahl</th>
                                    <th>Bestellungen</th>
                                    <th>Preis (Lieferant)</th>
                                </tr>
                            </thead>
                            <tbody>
                                {% for variant_data in article_data.variants %}
                                <tr>
                                    <td><strong>{{ variant_data.variant.color }}</strong></td>
                                    <td>{{ variant_data.variant.size }}</td>
                                    <td class="quantity">{{ variant_data.quantity }} StÃ¼ck</td>
                                    <td>{{ variant_data.order_count }} Bestellung(en)</td>
                                    <td class="price">{{ "%.2f"|format(variant_data.supplier_price / 100) }} CHF</td>
                                </tr>
                                {% endfor %}
                            </tbody>
                            <tfoot>
                                <tr class="total-row">
                                    <td colspan="2"><strong>Artikel-Gesamt</strong></td>
                                    <td class="quantity"><strong>{{ article_data.total_quantity }} StÃ¼ck</strong></td>
                                    <td></td>
                                    <td class="price"><strong>{{ "%.2f"|format(article_data.total_supplier_price / 100) }} CHF</strong></td>
                                </tr>
                            </tfoot>
                        </table>
                    </div>
                </div>
            </div>
            {% endfor %}
            
        {% else %}
            <div class="card">
                <div class="card-header">
                    <h2>Keine ausstehenden Bestellungen</h2>
                </div>
                <div class="card-body">
                    <div class="card card-secondary variant-info">
                        <div class="card-header">
                            <h3>âœ… Alles erledigt</h3>
                        </div>
                        <div class="card-body">
                            <p>Es gibt aktuell keine Bestellungen mit Status "Bestellt".</p>
                            <div class="card-actions primary">
                                <a href="{{ url_for('admin.merch_orders') }}" class="btn btn-outline">â† ZurÃ¼ck zu Bestellungen</a>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        {% endif %}
    </div>
</div>

<!-- Hidden content for copy functionality -->
<textarea id="copy-content" style="position: absolute; left: -9999px;">{% if pending_orders_count > 0 %}ğŸ“¦ LIEFERANTEN-BESTELLUNG - {{ "now"|format_datetime('%d.%m.%Y') }}

ğŸ“Š GESAMTÃœBERSICHT
Ausstehende Bestellungen: {{ pending_orders_count }}
Artikel: {{ total_stats.article_count }}
Varianten: {{ total_stats.variant_count }}
GesamtstÃ¼ckzahl: {{ total_stats.total_quantity }} StÃ¼ck
Lieferantenpreis: {{ "%.2f"|format(total_stats.total_supplier_price / 100) }} CHF

â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€

{% for article_data in articles_data %}ğŸ·ï¸ {{ article_data.article.name.upper() }}
{% for variant_data in article_data.variants %}{{ variant_data.variant.color }}, {{ variant_data.variant.size }}: {{ variant_data.quantity }} StÃ¼ck
{% endfor %}Artikel-Gesamt: {{ article_data.total_quantity }} StÃ¼ck ({{ "%.2f"|format(article_data.total_supplier_price / 100) }} CHF)

{% endfor %}â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
GESAMTPREIS: {{ "%.2f"|format(total_stats.total_supplier_price / 100) }} CHF
{% endif %}</textarea>

<script>
function copyToClipboard() {
    const textarea = document.getElementById('copy-content');
    textarea.select();
    textarea.setSelectionRange(0, 99999); // For mobile devices
    
    try {
        document.execCommand('copy');
        
        // Visual feedback
        const btn = event.target;
        const originalText = btn.innerHTML;
        btn.innerHTML = 'âœ… Kopiert!';
        btn.disabled = true;
        
        setTimeout(() => {
            btn.innerHTML = originalText;
            btn.disabled = false;
        }, 2000);
    } catch (err) {
        alert('Fehler beim Kopieren. Bitte manuell kopieren.');
    }
}
</script>

<style>
.stats-grid {
    display: grid;
    grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
    gap: 15px;
    margin-bottom: 20px;
}

.article-summary {
    display: flex;
    gap: 10px;
    align-items: center;
}

.summary-badge {
    padding: 4px 12px;
    background: var(--background-secondary);
    border-radius: var(--border-radius-sm);
    font-size: 14px;
    font-weight: bold;
    color: var(--accent-color);
}

.action-buttons {
    display: flex;
    gap: 10px;
    margin-top: 20px;
    flex-wrap: wrap;
}

.variants-table {
    overflow-x: auto;
    margin-top: 15px;
}

.variants-table table {
    width: 100%;
    border-collapse: collapse;
}

.variants-table th,
.variants-table td {
    padding: 12px;
    text-align: left;
    border-bottom: 1px solid var(--background-tertiary);
}

.variants-table th {
    background: var(--background-secondary);
    font-weight: bold;
    color: var(--text-secondary);
}

.variants-table tbody tr:hover {
    background: var(--background-secondary);
}

.variants-table .quantity {
    font-weight: bold;
    color: var(--accent-color);
}

.variants-table .price {
    text-align: right;
}

.variants-table tfoot {
    border-top: 2px solid var(--background-tertiary);
}

.variants-table .total-row td {
    padding-top: 15px;
    font-size: 16px;
}

.profit {
    color: var(--success-color, #28a745);
    font-weight: bold;
}

@media (max-width: 768px) {
    .stats-grid {
        grid-template-columns: 1fr;
    }
    
    .variants-table {
        font-size: 14px;
    }
    
    .variants-table th,
    .variants-table td {
        padding: 8px 6px;
    }
    
    .action-buttons {
        flex-direction: column;
    }
    
    .action-buttons .btn {
        width: 100%;
    }
}
</style>
{% endblock %}

