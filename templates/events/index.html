{% extends "base.html" %}
{% set use_v2_design = True %}

{% block title %}Events - Gourmen{% endblock %}

{% block content %}
<div class="container">
    <div class="page-header">
        <h1>
            <svg class="icon" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                <rect x="3" y="4" width="18" height="18" rx="2" ry="2"/>
                <line x1="16" y1="2" x2="16" y2="6"/>
                <line x1="8" y1="2" x2="8" y2="6"/>
                <line x1="3" y1="10" x2="21" y2="10"/>
            </svg>
            Events
        </h1>
        <p class="page-subtitle">Verwalte und plane deine Gourmen-Events</p>
    </div>
    
    <div class="page-content">
        {% if current_user.is_admin() %}
        <div class="card card--filter">
            <div class="card__body">
                <details class="disclosure">
                    <summary class="disclosure__summary">
                        <svg class="icon" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" aria-hidden="true">
                            <polyline points="6 9 12 15 18 9"/>
                        </svg>
                        Planung
                    </summary>
                    <div class="disclosure__content">
                        <div class="form-actions">
                            <a href="{{ url_for('admin.create_event') }}" class="btn btn--primary">
                                <svg class="icon" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                                    <line x1="12" y1="5" x2="12" y2="19"/>
                                    <line x1="5" y1="12" x2="19" y2="12"/>
                                </svg>
                                Event erfassen
                            </a>
                            <a href="{{ url_for('events.year_planning') }}" class="btn btn--primary">
                                <svg class="icon" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                                    <rect x="3" y="4" width="18" height="18" rx="2" ry="2"/>
                                    <line x1="16" y1="2" x2="16" y2="6"/>
                                    <line x1="8" y1="2" x2="8" y2="6"/>
                                    <line x1="3" y1="10" x2="21" y2="10"/>
                                </svg>
                                Jahresplanung erstellen
                            </a>
                        </div>
                    </div>
                </details>
            </div>
        </div>
        {% endif %}
        
        {% set tab_param = active_tab if active_tab is defined else request.args.get('tab', 'overview') %}
        <!-- Tabs Navigation -->
        <div class="tabs">
        <nav class="tabs__nav" role="tablist">
            <a href="{{ url_for('events.index', tab='overview') }}"
               class="tabs__tab {{ 'tabs__tab--active' if tab_param == 'overview' else '' }}"
               role="tab"
               aria-selected="{{ 'true' if tab_param == 'overview' else 'false' }}">
                <svg class="icon" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                    <rect x="3" y="3" width="7" height="7"/>
                    <rect x="14" y="3" width="7" height="7"/>
                    <rect x="14" y="14" width="7" height="7"/>
                    <rect x="3" y="14" width="7" height="7"/>
                </svg>
                Übersicht
            </a>
            <a href="{{ url_for('events.index', tab='kommend') }}"
               class="tabs__tab {{ 'tabs__tab--active' if tab_param == 'kommend' else '' }}"
               role="tab"
               aria-selected="{{ 'true' if tab_param == 'kommend' else 'false' }}">
                <svg class="icon" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                    <polyline points="9 18 15 12 9 6"/>
                </svg>
                Kommend
            </a>
            <a href="{{ url_for('events.index', tab='archiv') }}"
               class="tabs__tab {{ 'tabs__tab--active' if tab_param == 'archiv' else '' }}"
               role="tab"
               aria-selected="{{ 'true' if tab_param == 'archiv' else 'false' }}">
                <svg class="icon" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                    <rect x="2" y="3" width="20" height="18" rx="2" ry="2"/>
                    <path d="M8 21h8M12 7v8M8 11l4-4 4 4"/>
                </svg>
                Archiv
            </a>
            <a href="{{ url_for('events.index', tab='stats') }}"
               class="tabs__tab {{ 'tabs__tab--active' if tab_param == 'stats' else '' }}"
               role="tab"
               aria-selected="{{ 'true' if tab_param == 'stats' else 'false' }}">
                <svg class="icon" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                    <line x1="18" y1="20" x2="18" y2="10"/>
                    <line x1="12" y1="20" x2="12" y2="4"/>
                    <line x1="6" y1="20" x2="6" y2="14"/>
                </svg>
                Statistiken
            </a>
        </nav>
        
        <div class="tabs__content">
            <!-- Tab 1: Übersicht -->
            <div class="tabs__panel {{ 'tabs__panel--active' if tab_param == 'overview' else '' }}"
                 role="tabpanel">
                
                <!-- Aktuelles Event -->
                {% if current_event %}
                <div class="card">
                    {% set my_participation = current_event.participations|selectattr('member_id', 'equalto', current_user.id)|first %}
                    <div class="card__header">
                        <h2 class="card__title">
                            <svg class="icon" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                                <circle cx="12" cy="12" r="10"/>
                                <polyline points="12 6 12 12 16 14"/>
                            </svg>
                            Aktuelles Event
                        </h2>
                        <div class="card__actions">
                            {% if my_participation %}
                                {% if my_participation.teilnahme %}
                                    <span class="chip chip--success">Zugesagt</span>
                                {% else %}
                                    <span class="chip chip--danger">Abgesagt</span>
                                {% endif %}
                            {% else %}
                                <span class="chip chip--accent">Zu-/Absagen</span>
                            {% endif %}
                        </div>
                    </div>
                    <div class="card__body">
                        <div class="info-row">
                            <span class="info-row__label">Event:</span>
                            <span class="info-row__value">{{ current_event.event_typ.value }}</span>
                        </div>
                        <div class="info-row">
                            <span class="info-row__label">Datum:</span>
                            <span class="info-row__value">{{ current_event.display_date }}</span>
                        </div>
                        {% if current_event.restaurant %}
                        <div class="info-row">
                            <span class="info-row__label">Restaurant:</span>
                            <span class="info-row__value">{{ current_event.restaurant }}</span>
                        </div>
                        {% endif %}
                    </div>
                    <div class="card__footer">
                        {% if my_participation and my_participation.teilnahme %}
                        <a href="{{ url_for('events.detail', event_id=current_event.id, tab='billbro') }}" class="btn btn--billbro">
                            <svg class="icon" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                                <rect x="4" y="2" width="16" height="20" rx="2" ry="2"/>
                                <line x1="8" y1="6" x2="16" y2="6"/>
                                <line x1="8" y1="10" x2="16" y2="10"/>
                                <line x1="8" y1="14" x2="16" y2="14"/>
                                <line x1="8" y1="18" x2="16" y2="18"/>
                            </svg>
                            BillBro
                        </a>
                        {% endif %}
                        <a href="{{ url_for('events.detail', event_id=current_event.id) }}" class="btn btn--primary">
                            <svg class="icon" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                                <circle cx="11" cy="11" r="8"/>
                                <path d="m21 21-4.35-4.35"/>
                            </svg>
                            Zum Event
                        </a>
                    </div>
                </div>
                {% endif %}
                
                <!-- Letztes Event (Rating Reminder) -->
                {% if last_event %}
                    {% set last_participation = last_event.participations|selectattr('member_id', 'equalto', current_user.id)|first %}
                    {% if last_participation and last_participation.teilnahme and not last_event.has_rating_from_participant(current_user.id) %}
                    <div class="card">
                        <div class="card__header">
                            <h2 class="card__title">
                                <svg class="icon" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                                    <polygon points="12 2 15.09 8.26 22 9.27 17 14.14 18.18 21.02 12 17.77 5.82 21.02 7 14.14 2 9.27 8.91 8.26 12 2"/>
                                </svg>
                                Letztes Event bewerten
                            </h2>
                        </div>
                        <div class="card__body">
                            <div class="info-row">
                                <span class="info-row__label">Datum:</span>
                                <span class="info-row__value">{{ last_event.display_date }}</span>
                            </div>
                            {% if last_event.restaurant %}
                            <div class="info-row">
                                <span class="info-row__label">Restaurant:</span>
                                <span class="info-row__value">{{ last_event.restaurant }}</span>
                            </div>
                            {% endif %}
                        </div>
                        <div class="card__footer">
                            <a href="{{ url_for('ratings.rate_event', event_id=last_event.id) }}" class="btn btn--primary">
                                <svg class="icon" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                                    <polygon points="12 2 15.09 8.26 22 9.27 17 14.14 18.18 21.02 12 17.77 5.82 21.02 7 14.14 2 9.27 8.91 8.26 12 2"/>
                                </svg>
                                Jetzt bewerten
                            </a>
                        </div>
                    </div>
                    {% endif %}
                {% endif %}
                
                <!-- Nächstes Event -->
                {% if next_event %}
                <div class="card">
                    {% set my_participation = next_event.participations|selectattr('member_id', 'equalto', current_user.id)|first %}
                    <div class="card__header">
                        <h2 class="card__title">
                            <svg class="icon" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                                <polyline points="9 18 15 12 9 6"/>
                            </svg>
                            Nächstes Event
                        </h2>
                        <div class="card__actions">
                            {% if my_participation %}
                                {% if my_participation.teilnahme %}
                                    <span class="chip chip--success">Zugesagt</span>
                                {% else %}
                                    <span class="chip chip--danger">Abgesagt</span>
                                {% endif %}
                            {% else %}
                                <span class="chip chip--accent">Zu-/Absagen</span>
                            {% endif %}
                        </div>
                    </div>
                    <div class="card__body">
                        <div class="info-row">
                            <span class="info-row__label">Event:</span>
                            <span class="info-row__value">{{ next_event.event_typ.value }}</span>
                        </div>
                        <div class="info-row">
                            <span class="info-row__label">Datum:</span>
                            <span class="info-row__value">{{ next_event.display_date }}</span>
                        </div>
                        {% if next_event.restaurant %}
                        <div class="info-row">
                            <span class="info-row__label">Restaurant:</span>
                            <span class="info-row__value">{{ next_event.restaurant or 'TBD' }}</span>
                        </div>
                        {% endif %}
                    </div>
                    <div class="card__footer">
                        {% if my_participation %}
                            {% if my_participation.teilnahme %}
                            <form method="POST" action="{{ url_for('events.rsvp', event_id=next_event.id) }}" class="form form--inline">
                                <input type="hidden" name="csrf_token" value="{{ csrf_token() }}">
                                <input type="hidden" name="teilnahme" value="false">
                                <button type="submit" class="btn btn--danger">
                                    <svg class="icon" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                                        <line x1="18" y1="6" x2="6" y2="18"/>
                                        <line x1="6" y1="6" x2="18" y2="18"/>
                                    </svg>
                                    Absagen
                                </button>
                            </form>
                            {% else %}
                            <form method="POST" action="{{ url_for('events.rsvp', event_id=next_event.id) }}" class="form form--inline">
                                <input type="hidden" name="csrf_token" value="{{ csrf_token() }}">
                                <input type="hidden" name="teilnahme" value="true">
                                <button type="submit" class="btn btn--success">
                                    <svg class="icon" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                                        <polyline points="20 6 9 17 4 12"/>
                                    </svg>
                                    Zusagen
                                </button>
                            </form>
                            {% endif %}
                        {% else %}
                        <form method="POST" action="{{ url_for('events.rsvp', event_id=next_event.id) }}" class="form form--inline">
                            <input type="hidden" name="csrf_token" value="{{ csrf_token() }}">
                            <input type="hidden" name="teilnahme" value="true">
                            <button type="submit" class="btn btn--success">
                                <svg class="icon" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                                    <polyline points="20 6 9 17 4 12"/>
                                </svg>
                                Zusagen
                            </button>
                        </form>
                        <form method="POST" action="{{ url_for('events.rsvp', event_id=next_event.id) }}" class="form form--inline">
                            <input type="hidden" name="csrf_token" value="{{ csrf_token() }}">
                            <input type="hidden" name="teilnahme" value="false">
                            <button type="submit" class="btn btn--danger">
                                <svg class="icon" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                                    <line x1="18" y1="6" x2="6" y2="18"/>
                                    <line x1="6" y1="6" x2="18" y2="18"/>
                                </svg>
                                Absagen
                            </button>
                        </form>
                        {% endif %}
                        <a href="{{ url_for('events.detail', event_id=next_event.id) }}" class="btn btn--primary">
                            <svg class="icon" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                                <circle cx="11" cy="11" r="8"/>
                                <path d="m21 21-4.35-4.35"/>
                            </svg>
                            Zum Event
                        </a>
                    </div>
                </div>
                {% endif %}
                <!-- Empty State -->
                {% if not current_event and not next_event and not (last_event and last_participation and last_participation.teilnahme and not last_event.has_rating_from_participant(current_user.id)) %}
                <div class="card">
                    <div class="card__body">
                        <p>Keine Events verfügbar.</p>
                        {% if current_user.is_admin() %}
                        <div class="page-actions mt-4">
                            <a href="{{ url_for('events.year_planning') }}" class="btn btn--outline">Jahresplanung erstellen</a>
                        </div>
                        {% endif %}
                    </div>
                </div>
                {% endif %}
            </div>
            
            <!-- Tab 2: Kommend -->
            <div class="tabs__panel {{ 'tabs__panel--active' if tab_param == 'kommend' else '' }}"
                 role="tabpanel">
                {% if events %}
                {% for event in events %}
                {% set my_participation = event.participations|selectattr('member_id', 'equalto', current_user.id)|first %}
                <div class="card">
                    {% set avg_ratings = event.get_average_ratings() %}
                    {% set overall = avg_ratings.overall if avg_ratings.overall is defined else avg_ratings['overall'] %}
                    {% if overall >= 4 %}
                        {% set chip_color = '#10b981' %}
                    {% elif overall >= 3 %}
                        {% set chip_color = '#f59e0b' %}
                    {% else %}
                        {% set chip_color = '#ef4444' %}
                    {% endif %}
                    <div class="card__header">
                        <h2 class="card__title">
                            {% if event.event_typ.value == 'MONATSESSEN' %}
                            <svg class="icon" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                                <path d="M3 2v7c0 1.1.9 2 2 2h4a2 2 0 0 0 2-2V2"/>
                                <path d="M7 2v20"/>
                                <path d="M21 15V2v0a5 5 0 0 0-5 5v6c0 1.1.9 2 2 2h3Z"/>
                                <path d="M21 15v7"/>
                            </svg>
                            {% elif event.event_typ.value == 'GENERALVERSAMMLUNG' %}
                            <svg class="icon" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                                <path d="M3 3h18v7H3z"/>
                                <path d="M12 10v7"/>
                                <path d="M9 14h6"/>
                            </svg>
                            {% elif event.event_typ.value == 'AUSFLUG' %}
                            <svg class="icon" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                                <path d="M3 11h18"/>
                                <path d="M5 11l2.5-4.5a2 2 0 0 1 1.74-1H15a2 2 0 0 1 1.8 1.1L19 11"/>
                                <path d="M7 11v5a2 2 0 0 0 2 2h6a2 2 0 0 0 2-2v-5"/>
                            </svg>
                            {% else %}
                            <svg class="icon" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                                <rect x="3" y="4" width="18" height="18" rx="2" ry="2"/>
                                <line x1="16" y1="2" x2="16" y2="6"/>
                                <line x1="8" y1="2" x2="8" y2="6"/>
                                <line x1="3" y1="10" x2="21" y2="10"/>
                            </svg>
                            {% endif %}
                            {{ event.display_date }}
                        </h2>
                        <div class="card__actions">
                            {% if my_participation %}
                                {% if my_participation.teilnahme %}
                                    <span class="chip chip--success">Zugesagt</span>
                                {% else %}
                                    <span class="chip chip--danger">Abgesagt</span>
                                {% endif %}
                            {% else %}
                                <span class="chip chip--accent">Zu-/Absagen</span>
                            {% endif %}
                        </div>
                    </div>
                    <div class="card__body">
                        <div class="info-row">
                            <span class="info-row__label">Event:</span>
                            <span class="info-row__value">{{ event.event_typ.value }}</span>
                        </div>
                        <div class="info-row">
                            <span class="info-row__label">Organisator:</span>
                            <span class="info-row__value">{{ event.organisator.display_name_with_spirit }}</span>
                        </div>
                        {% if event.restaurant %}
                        <div class="info-row">
                            <span class="info-row__label">Restaurant:</span>
                            <span class="info-row__value">{{ event.restaurant }}</span>
                        </div>
                        {% endif %}
                    </div>
                    <div class="card__footer">
                        <a href="{{ url_for('events.detail', event_id=event.id) }}" class="btn btn--primary">
                            <svg class="icon" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                                <circle cx="11" cy="11" r="8"/>
                                <path d="m21 21-4.35-4.35"/>
                            </svg>
                            Details
                        </a>
                    </div>
                </div>
                {% endfor %}
                {% else %}
                <div class="card">
                    <div class="card__body">
                        <p>Keine kommenden Events verfügbar.</p>
                        {% if current_user.is_admin() %}
                        <div class="page-actions mt-4">
                            <a href="{{ url_for('events.year_planning') }}" class="btn btn--outline">Jahresplanung erstellen</a>
                        </div>
                        {% endif %}
                    </div>
                </div>
                {% endif %}
            </div>
            
            <!-- Tab 3: Archiv -->
            <div class="tabs__panel {{ 'tabs__panel--active' if tab_param == 'archiv' else '' }}"
                 role="tabpanel">
                <!-- Filter Section -->
                <div class="card card--filter">
                    <div class="card__body">
                        <details class="disclosure" {% if selected_year or selected_organizer_id %}open{% endif %}>
                            <summary class="disclosure__summary">
                                <svg class="icon" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" aria-hidden="true">
                                    <polyline points="6 9 12 15 18 9"/>
                                </svg>
                                Filter
                                {% if selected_year or selected_organizer_id %}
                                    {% if selected_year %}
                                    <span class="chip chip--info">{{ selected_year }}</span>
                                    {% endif %}
                                    {% if selected_organizer_id %}
                                        {% set selected_organizer = organizers|selectattr('id', 'equalto', selected_organizer_id)|first %}
                                        {% if selected_organizer %}
                                        <span class="chip chip--info">{{ selected_organizer.display_name_with_spirit }}</span>
                                        {% endif %}
                                    {% endif %}
                                {% endif %}
                            </summary>
                            <div class="disclosure__content">
                                <form method="GET" class="form">
                                    <input type="hidden" name="tab" value="archiv">
                                    <div class="form-row">
                                        <div class="form-field">
                                            <label for="year" class="form-field__label">Jahr</label>
                                            <select name="year" id="year" class="form-field__select">
                                                <option value="">Alle Jahre</option>
                                                {% if years %}
                                                {% for year in years %}
                                                <option value="{{ year }}" {% if year == selected_year %}selected{% endif %}>
                                                    {{ year }}
                                                </option>
                                                {% endfor %}
                                                {% endif %}
                                            </select>
                                        </div>
                                        <div class="form-field">
                                            <label for="organisator_id" class="form-field__label">Organisator</label>
                                            <select name="organisator_id" id="organisator_id" class="form-field__select">
                                                <option value="">Alle Organisatoren</option>
                                                {% if organizers %}
                                                {% for organizer in organizers %}
                                                <option value="{{ organizer.id }}" {% if selected_organizer_id == organizer.id %}selected{% endif %}>
                                                    {{ organizer.display_name_with_spirit }}
                                                </option>
                                                {% endfor %}
                                                {% endif %}
                                            </select>
                                        </div>
                                    </div>
                                    <div class="form-actions">
                                        <a class="btn btn--outline" href="{{ url_for('events.index', tab='archiv') }}">Zurücksetzen</a>
                                        <button type="submit" class="btn btn--primary">Filtern</button>
                                    </div>
                                </form>
                            </div>
                        </details>
                    </div>
                </div>
                
                <!-- Events List -->
                {% if events and events.items %}
                {% for event in events.items %}
                {% set rating_done = event.has_rating_from_participant(current_user.id) if event.has_rating_from_participant is defined else False %}
                {% set avg_ratings = event.get_average_ratings() or {} %}
                {% set overall = avg_ratings.get('overall', 0) %}
                {% set rating_count = avg_ratings.get('count', 0) %}
                {% set my_participation = event.participations|selectattr('member_id', 'equalto', current_user.id)|first if event.participations is defined else None %}
                {% set can_rate = ((my_participation and my_participation.teilnahme) or event.organisator_id == current_user.id) %}
                {% set rating_chip_class = 'chip chip--danger' %}
                {% if overall >= 4 %}
                    {% set rating_chip_class = 'chip chip--success' %}
                {% elif overall >= 3 %}
                    {% set rating_chip_class = 'chip chip--warning' %}
                {% endif %}
                <div class="card">
                    <div class="card__header">
                        <h2 class="card__title">
                            {% if event.event_typ.value == 'MONATSESSEN' %}
                            <svg class="icon" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                                <path d="M3 2v7c0 1.1.9 2 2 2h4a2 2 0 0 0 2-2V2"/>
                                <path d="M7 2v20"/>
                                <path d="M21 15V2v0a5 5 0 0 0-5 5v6c0 1.1.9 2 2 2h3Z"/>
                                <path d="M21 15v7"/>
                            </svg>
                            {% elif event.event_typ.value == 'GENERALVERSAMMLUNG' %}
                            <svg class="icon" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                                <path d="M3 3h18v7H3z"/>
                                <path d="M12 10v7"/>
                                <path d="M9 14h6"/>
                            </svg>
                            {% elif event.event_typ.value == 'AUSFLUG' %}
                            <svg class="icon" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                                <path d="M3 11h18"/>
                                <path d="M5 11l2.5-4.5a2 2 0 0 1 1.74-1H15a2 2 0 0 1 1.8 1.1L19 11"/>
                                <path d="M7 11v5a2 2 0 0 0 2 2h6a2 2 0 0 0 2-2v-5"/>
                            </svg>
                            {% else %}
                            <svg class="icon" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                                <rect x="3" y="4" width="18" height="18" rx="2" ry="2"/>
                                <line x1="16" y1="2" x2="16" y2="6"/>
                                <line x1="8" y1="2" x2="8" y2="6"/>
                                <line x1="3" y1="10" x2="21" y2="10"/>
                            </svg>
                            {% endif %}
                            {{ event.display_date }}
                        </h2>
                        <div class="card__actions">
                            {% if can_rate and not rating_done %}
                                <a class="chip chip--accent"
                                   href="{{ url_for('events.detail', event_id=event.id, tab='ratings', edit_rating='1') }}">
                                    Bewerten
                                </a>
                            {% elif rating_count > 0 %}
                                <a class="{{ rating_chip_class }}" href="{{ url_for('events.detail', event_id=event.id, tab='ratings') }}">
                                    <svg class="icon" aria-hidden="true" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                                        <polygon points="12 2 15.09 8.26 22 9.27 17 14.14 18.18 21.02 12 17.77 5.82 21.02 7 14.14 2 9.27 8.91 8.26 12 2"/>
                                    </svg>
                                    {{ "%.1f"|format(overall) }}
                                </a>
                            {% endif %}
                        </div>
                    </div>
                    <div class="card__body">
                        <div class="info-row">
                            <span class="info-row__label">Event:</span>
                            <span class="info-row__value">{{ event.event_typ.value }}</span>
                        </div>
                        {% if event.restaurant %}
                        <div class="info-row">
                            <span class="info-row__label">Restaurant:</span>
                            <span class="info-row__value">{{ event.restaurant }}</span>
                        </div>
                        {% endif %}
                        {% if event.kueche %}
                        <div class="info-row">
                            <span class="info-row__label">Küche:</span>
                            <span class="info-row__value">{{ event.kueche }}</span>
                        </div>
                        {% endif %}
                        <div class="info-row">
                            <span class="info-row__label">Organisator:</span>
                            <span class="info-row__value">{{ event.organisator.display_name_with_spirit }}</span>
                        </div>
                    </div>
                    
                    <div class="card__footer">
                        <a href="{{ url_for('events.detail', event_id=event.id) }}" class="btn btn--primary">
                            <svg class="icon" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                                <circle cx="11" cy="11" r="8"/>
                                <path d="m21 21-4.35-4.35"/>
                            </svg>
                            Details
                        </a>
                    </div>
                </div>
                {% endfor %}
                
                <!-- Pagination -->
                {% if events.pages > 1 %}
                <div class="page-actions page-actions--centered mt-6">
                    {% if events.has_prev %}
                    <a href="{{ url_for('events.index', tab='archiv', page=events.prev_num, year=selected_year if selected_year else '', organisator_id=selected_organizer_id if selected_organizer_id else '') }}" class="btn btn--outline">
                        <svg class="icon" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                            <path d="m12 19-7-7 7-7"/>
                            <path d="M19 12H5"/>
                        </svg>
                        Vorherige
                    </a>
                    {% endif %}
                    
                    <span class="page-info">
                        Seite {{ events.page }} von {{ events.pages }}
                    </span>
                    
                    {% if events.has_next %}
                    <a href="{{ url_for('events.index', tab='archiv', page=events.next_num, year=selected_year if selected_year else '', organisator_id=selected_organizer_id if selected_organizer_id else '') }}" class="btn btn--outline">
                        Nächste
                        <svg class="icon" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                            <path d="m12 5 7 7-7 7"/>
                            <path d="M19 12H5"/>
                        </svg>
                    </a>
                    {% endif %}
                </div>
                {% endif %}
                {% elif events and not events.items %}
                <div class="card">
                    <div class="card__body">
                        <p>Keine vergangenen Events im Archiv.</p>
                    </div>
                </div>
                {% endif %}
            </div>
            
            <!-- Tab 4: Statistiken -->
            <div class="tabs__panel {{ 'tabs__panel--active' if tab_param == 'stats' else '' }}"
                 role="tabpanel">
                <!-- Events -->
                <div class="card">
                    <div class="card__header">
                        <h2 class="card__title">
                            <svg class="icon" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                                <line x1="18" y1="20" x2="18" y2="10"/>
                                <line x1="12" y1="20" x2="12" y2="4"/>
                                <line x1="6" y1="20" x2="6" y2="14"/>
                            </svg>
                            Events
                        </h2>
                    </div>
                    <div class="card__body">
                        {% if total_past_events is defined %}
                        <div class="info-row">
                            <span class="info-row__label">Vergangene Events:</span>
                            <span class="info-row__value">{{ total_past_events }}</span>
                        </div>
                        {% endif %}
                        {% if avg_attendees is defined %}
                        <div class="info-row">
                            <span class="info-row__label">⊘ Teilnehmerzahl:</span>
                            <span class="info-row__value">{{ "%.1f"|format(avg_attendees) }}</span>
                        </div>
                        {% endif %}
                        {% if user_participation_rate is defined %}
                        <div class="info-row">
                            <span class="info-row__label">Deine Teilnahmequote:</span>
                            <span class="info-row__value">{{ "%.1f"|format(user_participation_rate) }}%</span>
                        </div>
                        {% endif %}
                        {% if organized_by_you is defined %}
                        <div class="info-row">
                            <span class="info-row__label">Von dir organisiert:</span>
                            <span class="info-row__value">{{ organized_by_you }}</span>
                        </div>
                        {% endif %}
                    </div>
                </div>

                <!-- Kosten -->
                {% if total_billbro_events is defined and total_billbro_events > 0 %}
                <div class="card">
                    <div class="card__header">
                        <h2 class="card__title">
                            <svg class="icon" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                                <rect x="4" y="2" width="16" height="20" rx="2" ry="2"/>
                                <line x1="8" y1="6" x2="16" y2="6"/>
                                <line x1="8" y1="10" x2="16" y2="10"/>
                                <line x1="8" y1="14" x2="16" y2="14"/>
                                <line x1="8" y1="18" x2="16" y2="18"/>
                            </svg>
                            Kosten
                        </h2>
                    </div>
                    <div class="card__body">
                        {% if avg_bill_amount is defined %}
                        <div class="info-row">
                            <span class="info-row__label">⊘ Rechnungsbetrag:</span>
                            <span class="info-row__value">{{ "%.2f"|format(avg_bill_amount) }} CHF</span>
                        </div>
                        {% endif %}
                        {% if avg_tip_amount is defined %}
                        <div class="info-row">
                            <span class="info-row__label">⊘ Trinkgeld (CHF):</span>
                            <span class="info-row__value">{{ "%.2f"|format(avg_tip_amount) }} CHF</span>
                        </div>
                        {% endif %}
                        {% if avg_tip_percent is defined %}
                        <div class="info-row">
                            <span class="info-row__label">⊘ Trinkgeld (%):</span>
                            <span class="info-row__value">{{ "%.1f"|format(avg_tip_percent) }}%</span>
                        </div>
                        {% endif %}
                    </div>
                </div>
                {% endif %}

            </div>
        </div>
    </div>
</div>
{% endblock %}
