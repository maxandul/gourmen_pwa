{% extends "base.html" %}

{% block title %}{{ event.event_typ.value }} - {{ event.display_date }} - Gourmen{% endblock %}

{% block content %}
<div class="container">
    <div class="welcome-section">
        <h1>{{ event.event_typ.value }} - {{ event.display_date }}</h1>
        <a href="{{ url_for('events.index') }}" class="btn btn-secondary">← Zurück zu Events</a>
    </div>
    
    <div class="event-details">
        <div class="card">
            <h3>Event-Details</h3>
            <div class="event-info">
                <div class="event-basic-info">
                    <p><strong>📅 Datum:</strong> {{ event.display_datetime }}</p>
                    <p><strong>🍽️ Typ:</strong> {{ event.event_typ.value }}</p>
                    <p><strong>👨‍🍳 Organisator:</strong> {{ event.organisator.display_name }}</p>
                    <p><strong>👥 Teilnehmer:</strong> {{ event.get_participation_count() }} / {{ event.get_total_participants() }}</p>
                </div>
                
                {% if event.restaurant or event.kueche or event.website or event.notizen or event.place_address %}
                <div class="event-location-info">
                    <h4>📍 Location & Details</h4>
                    {% if event.restaurant %}
                    <p><strong>🍽️ Restaurant:</strong> {{ event.restaurant }}</p>
                    {% endif %}
                    {% if event.place_address %}
                    <p><strong>📍 Adresse:</strong> {{ event.place_address }}</p>
                    {% endif %}
                    {% if event.kueche %}
                    <p><strong>🌍 Küche:</strong> {{ event.kueche }}</p>
                    {% endif %}
                    {% if event.place_price_level %}
                    <p><strong>💰 Preislevel:</strong> {{ '€' * event.place_price_level }}</p>
                    {% endif %}
                    {% if event.website %}
                    <p><strong>🌐 Website:</strong> 
                        <a href="{{ event.website }}" target="_blank" rel="noopener">{{ event.website }}</a>
                    </p>
                    {% endif %}
                    {% if event.place_maps_url %}
                    <p><strong>🗺️ Google Maps:</strong> 
                        <a href="{{ event.place_maps_url }}" target="_blank" rel="noopener">Auf Google Maps anzeigen</a>
                    </p>
                    {% endif %}
                    {% if event.notizen %}
                    <p><strong>📝 Notizen:</strong> {{ event.notizen }}</p>
                    {% endif %}
                </div>
                {% endif %}
            </div>
            
            <div class="event-actions">
                {% if current_user.is_admin or event.organisator_id == current_user.id %}
                <a href="{{ url_for('events.edit', event_id=event.id) }}" class="btn btn-secondary">Bearbeiten</a>
                {% endif %}
                
                <!-- Rating Section -->
                {% if event.is_past %}
                    {% set user_participation = participations|selectattr('member_id', 'equalto', current_user.id)|first %}
                    {% if user_participation and user_participation.teilnahme %}
                        {% if event.has_rating_from_participant(current_user.id) %}
                            <a href="{{ url_for('ratings.edit_rating', event_id=event.id) }}" class="btn btn-warning">
                                <i class="fas fa-star"></i> Bewertung bearbeiten
                            </a>
                        {% else %}
                            <a href="{{ url_for('ratings.rate_event', event_id=event.id) }}" class="btn btn-primary">
                                <i class="fas fa-star"></i> Event bewerten
                            </a>
                        {% endif %}
                    {% endif %}
                    
                    <a href="{{ url_for('ratings.view_ratings', event_id=event.id) }}" class="btn btn-info">
                        <i class="fas fa-chart-bar"></i> Bewertungen anzeigen
                    </a>
                {% endif %}
            </div>
        </div>
        
        <div class="card">
            <h3>Teilnahme</h3>
            
            <form method="POST" action="{{ url_for('events.rsvp', event_id=event.id) }}" id="rsvp-form">
                <input type="hidden" name="csrf_token" value="{{ csrf_token() }}">
                {% if participation and participation.teilnahme %}
                <p>Du nimmst an diesem Event teil.</p>
                <button type="submit" class="btn btn-warning">Absagen</button>
                {% else %}
                <p>Du nimmst nicht an diesem Event teil.</p>
                <button type="submit" class="btn btn-primary">Zusagen</button>
                {% endif %}
            </form>
            
            <!-- BillBro Link falls aktiv -->
            {% set billbro_active = event.rechnungsbetrag_rappen or event.participations|selectattr('guess_bill_amount_rappen')|list %}
            {% if participation and participation.teilnahme and billbro_active %}
            <div class="billbro-link">
                <a href="{{ url_for('billbro.index', event_id=event.id) }}" class="btn btn-success">
                    🍽️ Zu BillBro
                </a>
                {% if participation.has_guess %}
                <p><small>Du hast geschätzt: {{ participation.display_guess }} ({{ participation.esstyp.value if participation.esstyp else 'N/A' }})</small></p>
                {% endif %}
            </div>
            {% endif %}
        </div>
        
        {% if participations %}
        <div class="card">
            <h3>Teilnehmerliste</h3>
            <div class="participants-list">
                {% for participation in participations %}
                <div class="participant-item">
                    <span class="member">{{ participation.member.display_name }}</span>
                    <span class="status">
                        {% if participation.teilnahme %}
                        ✅ Teilnehmer
                        {% if billbro_active and participation.has_guess %}
                        <small>🍽️ Geschätzt</small>
                        {% elif billbro_active %}
                        <small>⏳ Wartet</small>
                        {% endif %}
                        {% else %}
                        ❌ Nicht teilnehmend
                        {% endif %}
                    </span>
                </div>
                {% endfor %}
            </div>
            
            {% if billbro_active %}
            <div class="billbro-summary">
                {% set participating = participations|selectattr('teilnahme', 'equalto', True)|list %}
                {% set with_guesses = participating|selectattr('has_guess')|list %}
                <p><strong>BillBro Status:</strong> {{ with_guesses|length }} / {{ participating|length }} haben geschätzt</p>
            </div>
            {% endif %}
        </div>
        {% endif %}
    </div>
</div>
{% endblock %} 