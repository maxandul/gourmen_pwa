{% extends "base.html" %}
{% set use_v2_design = True %}

{% block title %}{{ event.event_typ.value }} - {{ event.display_date }} - Gourmen{% endblock %}

{% block content %}
<div class="container">
    <nav class="breadcrumbs" aria-label="Breadcrumb">
        <div class="breadcrumbs__item">
            <a href="{{ url_for('events.index') }}" class="breadcrumbs__link">Events</a>
            <span class="breadcrumbs__separator">/</span>
        </div>
        <div class="breadcrumbs__item">
            <span class="breadcrumbs__current">{{ event.event_typ.value }} {{ event.display_date }}</span>
        </div>
    </nav>

    <div class="page-header">
        <h1>
            {% if event.event_typ.value == 'MONATSESSEN' %}
            <svg class="icon" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                <path d="M3 2v7c0 1.1.9 2 2 2h4a2 2 0 0 0 2-2V2"/>
                <path d="M7 2v20"/>
                <path d="M21 15V2v0a5 5 0 0 0-5 5v6c0 1.1.9 2 2 2h3Z"/>
                <path d="M21 15v7"/>
            </svg>
            {% elif event.event_typ.value == 'GENERALVERSAMMLUNG' %}
            <svg class="icon" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                <rect x="4" y="2" width="16" height="20" rx="2" ry="2"/>
                <path d="M9 22v-4a2 2 0 0 1 2-2h2a2 2 0 0 1 2 2v4"/>
                <path d="M8 6h.01M16 6h.01M12 6h.01M12 10h.01M12 14h.01M12 18h.01"/>
            </svg>
            {% elif event.event_typ.value == 'AUSFLUG' %}
            <svg class="icon" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                <path d="M16 22h2a2 2 0 0 0 2-2V7.5L14.5 2H6a2 2 0 0 0-2 2v3"/>
                <path d="M14 2v6h6"/>
                <path d="M10.5 7.5 13 10M8 17l6-6 2 2-6 6Z"/>
            </svg>
            {% else %}
            <svg class="icon" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                <rect x="3" y="4" width="18" height="18" rx="2" ry="2"/>
                <line x1="16" y1="2" x2="16" y2="6"/>
                <line x1="8" y1="2" x2="8" y2="6"/>
                <line x1="3" y1="10" x2="21" y2="10"/>
            </svg>
            {% endif %}
            {{ event.event_typ.value }} - {{ event.display_date }}
        </h1>
        <p class="page-subtitle">Alle Details zum Event</p>
        {% if current_user.is_admin or event.organisator_id == current_user.id %}
        <div class="page-actions page-actions--icons page-actions--right">
            <a href="{{ url_for('events.edit', event_id=event.id) }}"
               class="btn btn--icon-only"
               aria-label="Event bearbeiten"
               title="Event bearbeiten">
                <svg class="icon" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" aria-hidden="true">
                    <path d="M11 4H4a2 2 0 0 0-2 2v14a2 2 0 0 0 2 2h14a2 2 0 0 0 2-2v-7"/>
                    <path d="M18.5 2.5a2.121 2.121 0 0 1 3 3L12 15l-4 1 1-4 9.5-9.5z"/>
                </svg>
            </a>
            <form method="POST"
                  action="{{ url_for('events.delete', event_id=event.id) }}"
                  onsubmit="return confirm('Willst du dieses Event wirklich löschen? Diese Aktion kann nicht rückgängig gemacht werden.');"
                  style="display: inline;">
                <input type="hidden" name="csrf_token" value="{{ csrf_token() }}">
                <button type="submit"
                        class="btn btn--icon-only btn--danger"
                        aria-label="Event löschen"
                        title="Event löschen">
                    <svg class="icon" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" aria-hidden="true">
                        <polyline points="3 6 5 6 21 6"/>
                        <path d="M19 6v14a2 2 0 0 1-2 2H7a2 2 0 0 1-2-2V6"/>
                        <path d="M10 11v6"/>
                        <path d="M14 11v6"/>
                        <path d="M9 6V4a2 2 0 0 1 2-2h2a2 2 0 0 1 2 2v2"/>
                    </svg>
                </button>
            </form>
        </div>
        {% endif %}
    </div>
    
    <div class="page-content">
                {% set tab_param = active_tab if active_tab is defined else 'info' %}
        <div class="tabs" data-tabs>
            <nav class="tabs__nav" role="tablist">
                        <button class="tabs__tab {{ 'tabs__tab--active' if tab_param == 'info' else '' }}" type="button" role="tab" aria-selected="{{ 'true' if tab_param == 'info' else 'false' }}" data-tab-target="tab-info">Infos</button>
                        <button class="tabs__tab {{ 'tabs__tab--active' if tab_param == 'billbro' else '' }}" type="button" role="tab" aria-selected="{{ 'true' if tab_param == 'billbro' else 'false' }}" data-tab-target="tab-billbro">BillBro</button>
                        <button class="tabs__tab {{ 'tabs__tab--active' if tab_param == 'ratings' else '' }}" type="button" role="tab" aria-selected="{{ 'true' if tab_param == 'ratings' else 'false' }}" data-tab-target="tab-ratings">Bewertungen</button>
            </nav>

            <div class="tabs__content">
                <!-- Tab: Infos -->
                        <div class="tabs__panel {{ 'tabs__panel--active' if tab_param == 'info' else '' }}" id="tab-info" role="tabpanel">
                    <div class="card">
                        <div class="card__header">
                            <h2 class="card__title">
                                <svg class="icon" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                                    <path d="M14 2H6a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V8z"/>
                                    <polyline points="14 2 14 8 20 8"/>
                                    <line x1="16" y1="13" x2="8" y2="13"/>
                                    <line x1="16" y1="17" x2="8" y2="17"/>
                                    <polyline points="10 9 9 9 8 9"/>
                                </svg>
                                Event-Informationen
                            </h2>
                        </div>
                        <div class="card__body">
                            <div class="info-row">
                                <span class="info-row__label">Organisator:</span>
                                <span class="info-row__value">{{ event.organisator.display_name_with_spirit }}</span>
                            </div>
                            <div class="info-row">
                                <span class="info-row__label">Teilnehmer:</span>
                                <span class="info-row__value">{{ event.get_participation_count() }} von {{ event.get_total_members_count() }} Mitgliedern</span>
                            </div>
                            
                            {% if event.restaurant or event.kueche or event.website or event.notizen or event.place_address %}
                            {% if event.restaurant %}
                            <div class="info-row">
                                <span class="info-row__label">Restaurant:</span>
                                <span class="info-row__value">{{ event.restaurant }}</span>
                            </div>
                            {% endif %}
                            {% if event.place_maps_url %}
                            <div class="info-row">
                                <span class="info-row__label">Adresse:</span>
                                <span class="info-row__value">
                                    <a href="{{ event.place_maps_url }}" class="info-row__link" target="_blank" rel="noopener">Auf Google Maps anzeigen</a>
                                </span>
                            </div>
                            {% endif %}
                            {% if event.kueche %}
                            <div class="info-row">
                                <span class="info-row__label">Küche:</span>
                                <span class="info-row__value">{{ event.kueche }}</span>
                            </div>
                            {% elif event.place_types %}
                            <div class="info-row">
                                <span class="info-row__label">Küche:</span>
                                <span class="info-row__value">
                                    {% set cuisine_types = event.place_types|map('cuisine_type_mapper')|list %}
                                    {{ cuisine_types|join(', ') if cuisine_types else 'Restaurant' }}
                                </span>
                            </div>
                            {% endif %}
                            {% if event.place_price_level %}
                            <div class="info-row">
                                <span class="info-row__label">Preislevel:</span>
                                <span class="info-row__value">{{ '€' * event.place_price_level }}</span>
                            </div>
                            {% endif %}
                            {% if event.website %}
                            <div class="info-row">
                                <span class="info-row__label">Website:</span>
                                <span class="info-row__value">
                                    <a href="{{ event.website }}" class="info-row__link" target="_blank" rel="noopener">{{ event.website }}</a>
                                </span>
                            </div>
                            {% elif event.place_website %}
                            <div class="info-row">
                                <span class="info-row__label">Website:</span>
                                <span class="info-row__value">
                                    <a href="{{ event.place_website }}" class="info-row__link" target="_blank" rel="noopener">{{ event.place_website }}</a>
                                </span>
                            </div>
                            {% endif %}
                            {% if event.notizen %}
                            <div class="info-row">
                                <span class="info-row__label">Notizen:</span>
                                <span class="info-row__value">{{ event.notizen }}</span>
                            </div>
                            {% endif %}
                            {% endif %}
                        </div>
                    </div>

                    <div class="card">
                        <div class="card__header">
                            <h2 class="card__title">
                                <svg class="icon" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                                    <path d="M16 21v-2a4 4 0 0 0-4-4H6a4 4 0 0 0-4 4v2"/>
                                    <circle cx="9" cy="7" r="4"/>
                                    <path d="M22 21v-2a4 4 0 0 0-3-3.87"/>
                                    <path d="M16 3.13a4 4 0 0 1 0 7.75"/>
                                </svg>
                                Deine Teilnahme
                            </h2>
                        </div>
                        <div class="card__body">
                            {% if participation and participation.teilnahme %}
                            <p>Du nimmst an diesem Event teil.</p>
                            {% else %}
                            <p>Du nimmst nicht an diesem Event teil.</p>
                            {% endif %}
                            
                            <form method="POST" action="{{ url_for('events.rsvp', event_id=event.id) }}" id="rsvp-form" style="margin-top: var(--space-4);">
                                <input type="hidden" name="csrf_token" value="{{ csrf_token() }}">
                                {% if participation and participation.teilnahme %}
                                <button type="submit" class="btn btn--danger">
                                    <svg class="icon" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                                        <line x1="18" y1="6" x2="6" y2="18"/>
                                        <line x1="6" y1="6" x2="18" y2="18"/>
                                    </svg>
                                    Absagen
                                </button>
                                {% else %}
                                <button type="submit" class="btn btn--success">
                                    <svg class="icon" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                                        <polyline points="20 6 9 17 4 12"/>
                                    </svg>
                                    Zusagen
                                </button>
                                {% endif %}
                            </form>
                        </div>
                    </div>

                    <div class="card">
                        <div class="card__header">
                            <h2 class="card__title">
                                <svg class="icon" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                                    <path d="M17 21v-2a4 4 0 0 0-4-4H5a4 4 0 0 0-4 4v2"/>
                                    <circle cx="9" cy="7" r="4"/>
                                    <path d="M23 21v-2a4 4 0 0 0-3-3.87"/>
                                    <path d="M16 3.13a4 4 0 0 1 0 7.75"/>
                                </svg>
                                Teilnehmer-Übersicht
                            </h2>
                        </div>
                        <div class="card__body">
                            {% for member in all_members %}
                            {% set member_participation = participations|selectattr('member_id', 'equalto', member.id)|first %}
                            <div class="info-row">
                                <span class="info-row__label">{{ member.display_name_with_spirit }}</span>
                                <span class="info-row__value">
                                    {% if member_participation %}
                                        {% if member_participation.teilnahme %}
                                            <span class="participation-status participation-status--confirmed">Teilnehmer</span>
                                        {% else %}
                                            <span class="participation-status participation-status--declined">Absage</span>
                                        {% endif %}
                                    {% else %}
                                        <span class="participation-status participation-status--pending">Keine Antwort</span>
                                    {% endif %}
                                </span>
                            </div>
                            {% endfor %}
                        </div>
                    </div>
                </div>

                <!-- Tab: BillBro -->
                        <div class="tabs__panel {{ 'tabs__panel--active' if tab_param == 'billbro' else '' }}" id="tab-billbro" role="tabpanel">
                    {% set is_organizer = current_user.is_admin or event.organisator_id == current_user.id %}
                    {% if participation and participation.teilnahme %}
                    <!-- BillBro: Neue V2-Struktur -->

                    <!-- Deine Schätzung / Neue Schätzung als eigenständige Cards -->
                    {% if participation.has_guess %}
                    <div class="card">
                        <div class="card__header">
                            <h2 class="card__title">
                                <svg class="icon" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                                    <polyline points="20 6 9 17 4 12"/>
                                </svg>
                                Deine Schätzung
                            </h2>
                        </div>
                        <div class="card__body">
                            <div class="info-row">
                                <span class="info-row__label">Schätzung</span>
                                <span class="info-row__value">{{ participation.display_guess }}</span>
                            </div>
                            <div class="info-row">
                                <span class="info-row__label">Ess-Typ</span>
                                <span class="info-row__value">{{ participation.esstyp.value if participation.esstyp else 'Nicht gewählt' }}</span>
                            </div>
                            {% if event.rechnungsbetrag_rappen %}
                            <div class="info-row">
                                <span class="info-row__label">Differenz</span>
                                <span class="info-row__value">{{ participation.display_diff }}</span>
                            </div>
                            <div class="info-row">
                                <span class="info-row__label">Rang</span>
                                <span class="info-row__value">{{ participation.rank }}. Platz</span>
                            </div>
                            {% endif %}
                        </div>
                        <div class="card__footer">
                            {% if not event.billbro_closed %}
                            <form method="POST" action="{{ url_for('billbro.update_guess', event_id=event.id) }}" class="form" style="margin:0;">
                                <input type="hidden" name="csrf_token" value="{{ csrf_token() }}">
                                <button type="submit" class="btn btn--outline">
                                    <svg class="icon" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                                        <path d="M11 4H4a2 2 0 0 0-2 2v14a2 2 0 0 0 2 2h14a2 2 0 0 0 2-2v-7"/>
                                        <path d="M18.5 2.5a2.121 2.121 0 0 1 3 3L12 15l-4 1 1-4 9.5-9.5z"/>
                                    </svg>
                                    Schätzung bearbeiten
                                </button>
                            </form>
                            {% else %}
                            <p class="text-muted">BillBro ist abgeschlossen – keine Änderungen mehr möglich.</p>
                            {% endif %}
                        </div>
                    </div>
                    {% else %}
                    <div class="card">
                        <div class="card__header">
                            <h2 class="card__title">
                                <svg class="icon" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                                    <path d="M12 20h9"/>
                                    <path d="M12 4h9"/>
                                    <path d="M12 12h9"/>
                                    <path d="M3 6h.01"/>
                                    <path d="M3 12h.01"/>
                                    <path d="M3 18h.01"/>
                                </svg>
                                Neue Schätzung abgeben
                            </h2>
                        </div>
                        <div class="card__body">
                            {% if not event.billbro_closed %}
                            {% if form is defined %}
                                <form method="POST" action="{{ url_for('billbro.compute', event_id=event.id) }}" class="form">
                                    <input type="hidden" name="csrf_token" value="{{ csrf_token() }}">
                                    
                                    <div class="form-field">
                                        {{ form.esstyp.label(class_="form-field__label") }}
                                        {{ form.esstyp(class_="form-field__select") }}
                                        {% if form.esstyp.errors %}
                                        <span class="form-field__error">{{ form.esstyp.errors[0] }}</span>
                                        {% endif %}
                                    </div>
                                    
                                    <div class="form-field">
                                        {{ form.guess_amount.label(class_="form-field__label") }}
                                        {{ form.guess_amount(class_="form-field__input", placeholder="z.B. 45.50") }}
                                        {% if form.guess_amount.errors %}
                                        <span class="form-field__error">{{ form.guess_amount.errors[0] }}</span>
                                        {% endif %}
                                    </div>
                                    
                                    <div class="form-actions">
                                        <button type="submit" class="btn btn--primary">
                                            <svg class="icon" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                                                <polyline points="20 6 9 17 4 12"/>
                                            </svg>
                                            Schätzung abgeben
                                        </button>
                                    </div>
                                </form>
                            {% else %}
                                <p class="text-muted">Formular nicht verfügbar.</p>
                            {% endif %}
                            {% else %}
                            <p class="text-muted">BillBro ist abgeschlossen – keine neuen Schätzungen möglich.</p>
                            {% endif %}
                        </div>
                    </div>
                    {% endif %}

                    {% if is_organizer %}
                    <!-- Organizer: Anwesenheit & Schätzungen -->
                    <div class="card">
                        <div class="card__header">
                            <h2 class="card__title">
                                <svg class="icon" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                                    <path d="M16 21v-2a4 4 0 0 0-4-4H6a4 4 0 0 0-4 4v2"/>
                                    <circle cx="9" cy="7" r="4"/>
                                    <path d="M22 21v-2a4 4 0 0 0-3-3.87"/>
                                    <path d="M16 3.13a4 4 0 0 1 0 7.75"/>
                                </svg>
                                Anwesenheits-Check
                            </h2>
                        </div>
                        <div class="card__body">
                            <p class="text-muted">Bestätige, wer wirklich anwesend ist, bevor du die Rechnung eingibst.</p>
                            <div class="card-section card-section--subtle">
                                <div class="card-section__body">
                                    {# Zusagen zuerst #}
                                    {% for member in all_members %}
                                    {% set member_participation = event.participations|selectattr('member_id', 'equalto', member.id)|first %}
                                    {% if member_participation and member_participation.teilnahme %}
                                    <div class="info-row">
                                        <span class="info-row__label">{{ member.display_name_with_spirit }}</span>
                                        <div class="info-row__value info-row__value--actions">
                                            {{ member_participation.display_guess if member_participation.has_guess else 'Wartet auf Schätzung' }}
                                            {% if not member_participation.has_guess %}
                                            <form method="POST" action="{{ url_for('billbro.mark_absent', event_id=event.id, member_id=member.id) }}" class="form">
                                                <input type="hidden" name="csrf_token" value="{{ csrf_token() }}">
                                                <button type="submit" class="btn btn--outline btn--sm" onclick="return confirm('{{ member.display_name_with_spirit }} ist nicht da?')">Nicht da</button>
                                            </form>
                                            {% endif %}
                                        </div>
                                    </div>
                                    {% endif %}
                                    {% endfor %}

                                    {# Abgesagt #}
                                    {% for member in all_members %}
                                    {% set member_participation = event.participations|selectattr('member_id', 'equalto', member.id)|first %}
                                    {% if member_participation and not member_participation.teilnahme %}
                                    <div class="info-row">
                                        <span class="info-row__label">{{ member.display_name_with_spirit }}</span>
                                        <div class="info-row__value info-row__value--actions">Abgesagt</div>
                                    </div>
                                    {% endif %}
                                    {% endfor %}

                                    {# Keine Antwort #}
                                    {% for member in all_members %}
                                    {% set member_participation = event.participations|selectattr('member_id', 'equalto', member.id)|first %}
                                    {% if not member_participation %}
                                    <div class="info-row">
                                        <span class="info-row__label">{{ member.display_name_with_spirit }}</span>
                                        <div class="info-row__value info-row__value--actions">Keine Antwort</div>
                                    </div>
                                    {% endif %}
                                    {% endfor %}
                                </div>
                            </div>
                        </div>
                    </div>
                    {% endif %}

                    <!-- Rechnung & Berechnung als eigenständige Cards -->
                    {# Hinweis/Button unter Anwesenheitscheck #}
                    {% if is_organizer %}
                    <div class="page-actions" style="justify-content: flex-end; margin-top: var(--space-4);">
                        {% set total_attending = event.participations|selectattr('teilnahme','equalto',True)|list %}
                        {% set pending_guesses = total_attending|selectattr('guess_bill_amount_rappen','equalto',None)|list %}
                        {% if event.billbro_closed %}
                        <form method="POST" action="{{ url_for('billbro.toggle_billbro_status', event_id=event.id) }}" class="form" style="margin:0;">
                            <input type="hidden" name="csrf_token" value="{{ csrf_token() }}">
                            <button type="submit" class="btn btn--outline">Schätzrunde öffnen</button>
                        </form>
                        {% elif pending_guesses|length > 0 %}
                        <span class="text-muted">Warten auf Schätzungen ({{ pending_guesses|length }})</span>
                        {% else %}
                        <form method="POST" action="{{ url_for('billbro.toggle_billbro_status', event_id=event.id) }}" class="form" style="margin:0;">
                            <input type="hidden" name="csrf_token" value="{{ csrf_token() }}">
                            <button type="submit" class="btn btn--primary">Schätzrunde schließen</button>
                        </form>
                        {% endif %}
                    </div>
                    {% endif %}

                    {% if is_organizer and event.billbro_closed %}
                    <div class="card">
                        <div class="card__header">
                            <h2 class="card__title">Rechnungsbetrag eingeben</h2>
                        </div>
                        <div class="card__body">
                            <form method="POST" action="{{ url_for('billbro.enter_bill', event_id=event.id) }}" class="form">
                                <input type="hidden" name="csrf_token" value="{{ csrf_token() }}">
                                <div class="form-field">
                                    <label class="form-field__label" for="rechnungsbetrag">Rechnungsbetrag (CHF)</label>
                                    <input type="number" id="rechnungsbetrag" name="rechnungsbetrag" step="0.01" min="0" class="form-field__input" required>
                                </div>
                                <div class="form-actions">
                                    <button type="submit" class="btn btn--primary">
                                        <svg class="icon" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                                            <path d="M12 3v18"/>
                                            <path d="M17 8H9a3 3 0 0 0 0 6h6a3 3 0 0 1 0 6H6"/>
                                        </svg>
                                        Berechnen
                                    </button>
                                </div>
                            </form>
                        </div>
                    </div>
                    {% endif %}

                    {% if event.rechnungsbetrag_rappen %}
                    <div class="card">
                        <div class="card__header">
                            <h2 class="card__title">Rechnungsübersicht</h2>
                        </div>
                        <div class="card__body">
                            <div class="info-row">
                                <span class="info-row__label">Rechnungsbetrag</span>
                                <span class="info-row__value">{{ "%.2f"|format(event.rechnungsbetrag_rappen / 100) }} CHF</span>
                            </div>
                            <div class="info-row">
                                <span class="info-row__label">Trinkgeld (7%)</span>
                                <span class="info-row__value">{{ "%.2f"|format(event.trinkgeld_rappen / 100) }} CHF</span>
                            </div>
                            <div class="info-row">
                                <span class="info-row__label">Vorschlag Gesamtbetrag</span>
                                <span class="info-row__value">{{ "%.2f"|format(((event.rechnungsbetrag_rappen + event.trinkgeld_rappen + 999) // 1000 * 1000) / 100) }} CHF</span>
                            </div>
                        </div>
                        {% if is_organizer and not event.billbro_closed %}
                        <div class="card__footer">
                            <form method="POST" action="{{ url_for('billbro.accept_suggested_total', event_id=event.id) }}" class="form">
                                <input type="hidden" name="csrf_token" value="{{ csrf_token() }}">
                                <button type="submit" class="btn btn--success">
                                    <svg class="icon" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                                        <polyline points="20 6 9 17 4 12"/>
                                    </svg>
                                    Vorschlag übernehmen
                                </button>
                            </form>
                            <button type="button" class="btn btn--outline" data-manual-toggle="manual-total">
                                <svg class="icon" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                                    <path d="M4 7h16"/>
                                    <path d="M10 11h10"/>
                                    <path d="M4 15h16"/>
                                </svg>
                                Gesamtbetrag anpassen
                            </button>
                        </div>
                        {% endif %}
                    </div>

                    {% if is_organizer and not event.billbro_closed %}
                    <div class="card" id="manual-total" hidden>
                        <div class="card__header">
                            <h2 class="card__title">Manuelle Anpassung</h2>
                        </div>
                        <div class="card__body">
                            <form method="POST" action="{{ url_for('billbro.set_total', event_id=event.id) }}" class="form">
                                <input type="hidden" name="csrf_token" value="{{ csrf_token() }}">
                                <div class="form-field">
                                    <label class="form-field__label" for="gesamtbetrag_manual">Gewünschter Gesamtbetrag (CHF)</label>
                                    <input type="number" id="gesamtbetrag_manual" name="gesamtbetrag_manual" step="0.01" min="0" class="form-field__input" value="{{ event.gesamtbetrag_rappen / 100 if event.gesamtbetrag_rappen else '' }}" placeholder="z.B. {{ '%.0f'|format(((event.rechnungsbetrag_rappen + event.trinkgeld_rappen + 999) // 1000 * 1000) / 100) }}">
                                </div>
                                <div class="form-actions">
                                    <button type="submit" class="btn btn--primary">
                                        <svg class="icon" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                                            <polyline points="20 6 9 17 4 12"/>
                                        </svg>
                                        Gesamtbetrag speichern
                                    </button>
                                </div>
                            </form>
                        </div>
                    </div>
                    {% endif %}

                    {% if event.gesamtbetrag_rappen %}
                    <div class="card">
                        <div class="card__header">
                            <h2 class="card__title">Finaler Betrag</h2>
                        </div>
                        <div class="card__body">
                            <div class="info-row">
                                <span class="info-row__label">Gesamtbetrag</span>
                                <span class="info-row__value">{{ "%.2f"|format(event.gesamtbetrag_rappen / 100) }} CHF</span>
                            </div>
                            <div class="info-row">
                                <span class="info-row__label">Effektives Trinkgeld</span>
                                <span class="info-row__value">
                                    {{ "%.2f"|format((event.gesamtbetrag_rappen - event.rechnungsbetrag_rappen) / 100) }} CHF
                                    <small>({{ "%.1f"|format((event.gesamtbetrag_rappen - event.rechnungsbetrag_rappen) / event.rechnungsbetrag_rappen * 100) }}%)</small>
                                </span>
                            </div>
                        </div>
                    </div>

                    <div class="card">
                        <div class="card__header">
                            <h2 class="card__title">Dein Anteil</h2>
                        </div>
                        <div class="card__body">
                            {% if participation.esstyp %}
                            <div class="info-row">
                                <span class="info-row__label">Dein Anteil</span>
                                <span class="info-row__value">
                                    {% if participation.esstyp.name == 'SPARSAM' and event.betrag_sparsam_rappen %}
                                        {{ "%.2f"|format(event.betrag_sparsam_rappen / 100) }} CHF (Sparsam)
                                    {% elif participation.esstyp.name == 'NORMAL' and event.betrag_normal_rappen %}
                                        {{ "%.2f"|format(event.betrag_normal_rappen / 100) }} CHF (Normal)
                                    {% elif participation.esstyp.name == 'ALLIN' and event.betrag_allin_rappen %}
                                        {{ "%.2f"|format(event.betrag_allin_rappen / 100) }} CHF (All-In)
                                    {% else %}
                                        Noch nicht berechnet
                                    {% endif %}
                                </span>
                            </div>
                            {% else %}
                            <p class="text-muted">Bitte wähle deinen Ess-Typ.</p>
                            {% endif %}
                        </div>
                    </div>

                    <div class="card">
                        <div class="card__header">
                            <h2 class="card__title">Anteile pro Ess-Typ</h2>
                        </div>
                        <div class="card__body">
                            <div class="info-row">
                                <span class="info-row__label">Sparsam</span>
                                <span class="info-row__value">{{ "%.2f"|format(event.betrag_sparsam_rappen / 100) if event.betrag_sparsam_rappen else "Nicht berechnet" }} CHF</span>
                            </div>
                            <div class="info-row">
                                <span class="info-row__label">Normal</span>
                                <span class="info-row__value">{{ "%.2f"|format(event.betrag_normal_rappen / 100) if event.betrag_normal_rappen else "Nicht berechnet" }} CHF</span>
                            </div>
                            <div class="info-row">
                                <span class="info-row__label">All-In</span>
                                <span class="info-row__value">{{ "%.2f"|format(event.betrag_allin_rappen / 100) if event.betrag_allin_rappen else "Nicht berechnet" }} CHF</span>
                            </div>
                        </div>
                    </div>
                    {% endif %}
                    {% endif %}

                    {% if event.gesamtbetrag_rappen %}
                    <!-- Rangliste -->
                    {% set ranked = event.participations
                            | selectattr('teilnahme','equalto', True)
                            | rejectattr('guess_bill_amount_rappen', 'equalto', none)
                            | list %}
                    {% set ranked = ranked|sort(attribute='diff_amount_rappen') %}
                    <div class="card">
                        <div class="card__header">
                            <h2 class="card__title">
                                <svg class="icon" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                                    <polygon points="12 2 15.09 8.26 22 9.27 17 14.14 18.18 21.02 12 17.77 5.82 21.02 7 14.14 2 9.27 8.91 8.26 12 2"/>
                                </svg>
                                Schätzungsrangliste
                            </h2>
                        </div>
                        <div class="card__body">
                            {% for p in ranked %}
                            <div class="info-row">
                                <span class="info-row__label">{{ loop.index }}. {{ p.member.display_name_with_spirit }}</span>
                                <span class="info-row__value">
                                    {{ "%.2f"|format((p.guess_bill_amount_rappen or 0)/100) }} CHF
                                    {% if p.diff_amount_rappen is not none %}
                                    <small class="ranking-diff">(Δ {{ "%.2f"|format(p.diff_amount_rappen/100) }} CHF)</small>
                                    {% endif %}
                                </span>
                            </div>
                            {% endfor %}
                        </div>
                    </div>
                    {% endif %}

                    {% else %}
                    <div class="card">
                        <div class="card__body">
                            <p>BillBro steht nur Teilnehmenden zur Verfügung.</p>
                        </div>
                    </div>
                    {% endif %}
                </div>

                <!-- Tab: Bewertungen -->
                        <div class="tabs__panel {{ 'tabs__panel--active' if tab_param == 'ratings' else '' }}" id="tab-ratings" role="tabpanel">
                    <div class="card">
                        <div class="card__header">
                            <h2 class="card__title">
                                <svg class="icon" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                                    <polygon points="12 2 15.09 8.26 22 9.27 17 14.14 18.18 21.02 12 17.77 5.82 21.02 7 14.14 2 9.27 8.91 8.26 12 2"/>
                                </svg>
                                Bewertungen
                            </h2>
                        </div>
                        <div class="card__body">
                            {% set user_participation = participations|selectattr('member_id', 'equalto', current_user.id)|first %}
                            {% if user_participation and user_participation.teilnahme %}
                                {% if event.has_rating_from_participant(current_user.id) %}
                                <a href="{{ url_for('ratings.edit_rating', event_id=event.id) }}" class="btn btn--primary">
                                    <svg class="icon" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                                        <path d="M11 4H4a2 2 0 0 0-2 2v14a2 2 0 0 0 2 2h14a2 2 0 0 0 2-2v-7"/>
                                        <path d="M18.5 2.5a2.121 2.121 0 0 1 3 3L12 15l-4 1 1-4 9.5-9.5z"/>
                                    </svg>
                                    Bewertung bearbeiten
                                </a>
                                {% else %}
                                <a href="{{ url_for('ratings.rate_event', event_id=event.id) }}" class="btn btn--primary">
                                    <svg class="icon" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                                        <polygon points="12 2 15.09 8.26 22 9.27 17 14.14 18.18 21.02 12 17.77 5.82 21.02 7 14.14 2 9.27 8.91 8.26 12 2"/>
                                    </svg>
                                    Event bewerten
                                </a>
                                {% endif %}
                            {% else %}
                            <p>Bewertungen stehen nur Teilnehmenden zur Verfügung.</p>
                            {% endif %}

                            <div style="margin-top: var(--space-4); border-top: 1px solid var(--color-border-subtle); padding-top: var(--space-4);">
                                <a href="{{ url_for('ratings.view_ratings', event_id=event.id) }}" class="btn btn--primary">
                                    <svg class="icon" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                                        <line x1="18" y1="20" x2="18" y2="10"/>
                                        <line x1="12" y1="20" x2="12" y2="4"/>
                                        <line x1="6" y1="20" x2="6" y2="14"/>
                                    </svg>
                                    Bewertungen anzeigen
                                </a>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Buttons außerhalb der Cards -->
        <div class="page-actions">
            <!-- RSVP Erinnerung Button für Organisator -->
            {% if current_user.is_admin or event.organisator_id == current_user.id %}
            {% if event.is_upcoming %}
            <button type="button" class="btn btn--primary send-rsvp-reminder-btn" 
                    data-event-id="{{ event.id }}">
                <svg class="icon" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                    <path d="M18 8A6 6 0 0 0 6 8c0 7-3 9-3 9h18s-3-2-3-9"/>
                    <path d="M13.73 21a2 2 0 0 1-3.46 0"/>
                </svg>
                Push-Erinnerung senden
            </button>
            {% endif %}
            {% endif %}
            
            {% if current_user.is_admin and not event.is_past %}
            <button type="button" class="btn btn--danger delete-event-btn" 
                    data-event-id="{{ event.id }}" 
                    data-event-title="{{ event.restaurant or event.event_typ.value }}">
                <svg class="icon" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                    <polyline points="3 6 5 6 21 6"/>
                    <path d="M19 6v14a2 2 0 0 1-2 2H7a2 2 0 0 1-2-2V6m3 0V4a2 2 0 0 1 2-2h4a2 2 0 0 1 2 2v2"/>
                </svg>
                Löschen
            </button>
            {% endif %}
        </div>
    </div>
</div>

<script>
document.addEventListener('DOMContentLoaded', function() {
    // Tabs (JS-basiert)
    const tabContainer = document.querySelector('[data-tabs]');
    if (tabContainer) {
        const tabs = Array.from(tabContainer.querySelectorAll('[data-tab-target]'));
        const panels = Array.from(tabContainer.querySelectorAll('.tabs__panel'));

        const activate = (targetId) => {
            tabs.forEach((t) => {
                const active = t.getAttribute('data-tab-target') === targetId;
                t.classList.toggle('tabs__tab--active', active);
                t.setAttribute('aria-selected', active ? 'true' : 'false');
            });
            panels.forEach((p) => {
                const active = p.id === targetId;
                p.classList.toggle('tabs__panel--active', active);
            });
        };

        tabContainer.addEventListener('click', (e) => {
            const btn = e.target.closest('[data-tab-target]');
            if (!btn) return;
            activate(btn.getAttribute('data-tab-target'));
        });
    }

    // Handle RSVP reminder button
    const rsvpReminderBtn = document.querySelector('.send-rsvp-reminder-btn');
    if (rsvpReminderBtn) {
        rsvpReminderBtn.addEventListener('click', function() {
            if (confirm('Push-Benachrichtigung an alle Mitglieder senden, die noch nicht geantwortet haben?\n\nHinweis: Nur Mitglieder mit aktivierten Push-Benachrichtigungen erhalten die Erinnerung.')) {
                const eventId = this.getAttribute('data-event-id');
                const form = document.createElement('form');
                form.method = 'POST';
                form.action = '/events/' + eventId + '/send_rsvp_reminder';
                
                const csrf = document.createElement('input');
                csrf.type = 'hidden';
                csrf.name = 'csrf_token';
                csrf.value = '{{ csrf_token() }}';
                form.appendChild(csrf);
                
                document.body.appendChild(form);
                form.submit();
            }
        });
    }
    
    // Handle delete event buttons
    document.querySelectorAll('.delete-event-btn').forEach(function(button) {
        button.addEventListener('click', function() {
            const eventId = this.getAttribute('data-event-id');
            const eventTitle = this.getAttribute('data-event-title');
            
            if (confirm('Möchtest du das Event "' + eventTitle + '" wirklich löschen? Diese Aktion kann nicht rückgängig gemacht werden.')) {
                const form = document.createElement('form');
                form.method = 'POST';
                form.action = '/events/' + eventId + '/delete';
                
                const csrf = document.createElement('input');
                csrf.type = 'hidden';
                csrf.name = 'csrf_token';
                csrf.value = '{{ csrf_token() }}';
                form.appendChild(csrf);
                
                document.body.appendChild(form);
                form.submit();
            }
        });
    });

    // Manuelle Gesamtbetragsanpassung ein-/ausblenden
    document.querySelectorAll('[data-manual-toggle]').forEach((button) => {
        const targetId = button.getAttribute('data-manual-toggle');
        const target = document.getElementById(targetId);
        if (!target) return;

        button.addEventListener('click', () => {
            const willShow = target.hasAttribute('hidden');
            if (willShow) {
                target.removeAttribute('hidden');
                target.scrollIntoView({ behavior: 'smooth', block: 'start' });
            } else {
                target.setAttribute('hidden', '');
            }
        });
    });
});
</script>
{% endblock %}
