{% extends "base.html" %}
{% set use_v2_design = True %}

{% block title %}{{ event.event_typ.value }} - {{ event.display_date }} - Gourmen{% endblock %}

{% block content %}
<div class="container">
    <nav class="breadcrumbs" aria-label="Breadcrumb">
        <div class="breadcrumbs__item">
            <a href="{{ url_for('events.index') }}" class="breadcrumbs__link">Events</a>
            <span class="breadcrumbs__separator">/</span>
        </div>
        <div class="breadcrumbs__item">
            <span class="breadcrumbs__current">Event-Details</span>
        </div>
    </nav>

    <div class="page-header">
        <h1>
            {% if event.event_typ.value == 'MONATSESSEN' %}
            <svg class="icon" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                <path d="M3 2v7c0 1.1.9 2 2 2h4a2 2 0 0 0 2-2V2"/>
                <path d="M7 2v20"/>
                <path d="M21 15V2v0a5 5 0 0 0-5 5v6c0 1.1.9 2 2 2h3Z"/>
                <path d="M21 15v7"/>
            </svg>
            {% elif event.event_typ.value == 'GENERALVERSAMMLUNG' %}
            <svg class="icon" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                <rect x="4" y="2" width="16" height="20" rx="2" ry="2"/>
                <path d="M9 22v-4a2 2 0 0 1 2-2h2a2 2 0 0 1 2 2v4"/>
                <path d="M8 6h.01M16 6h.01M12 6h.01M12 10h.01M12 14h.01M12 18h.01"/>
            </svg>
            {% elif event.event_typ.value == 'AUSFLUG' %}
            <svg class="icon" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                <path d="M16 22h2a2 2 0 0 0 2-2V7.5L14.5 2H6a2 2 0 0 0-2 2v3"/>
                <path d="M14 2v6h6"/>
                <path d="M10.5 7.5 13 10M8 17l6-6 2 2-6 6Z"/>
            </svg>
            {% else %}
            <svg class="icon" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                <rect x="3" y="4" width="18" height="18" rx="2" ry="2"/>
                <line x1="16" y1="2" x2="16" y2="6"/>
                <line x1="8" y1="2" x2="8" y2="6"/>
                <line x1="3" y1="10" x2="21" y2="10"/>
            </svg>
            {% endif %}
            {{ event.event_typ.value }} - {{ event.display_date }}
        </h1>
        <p class="page-subtitle">Alle Details zum Event</p>
    </div>
    
    <div class="page-content">
        {% if current_user.is_admin or event.organisator_id == current_user.id %}
        <div class="card card--filter">
            <div class="card__body">
                <details class="disclosure">
                    <summary class="disclosure__summary">
                        <svg class="icon" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" aria-hidden="true">
                            <polyline points="6 9 12 15 18 9"/>
                        </svg>
                        Planung (Organisator/Admin)
                    </summary>
                    <div class="disclosure__content">
                        <div class="form-actions">
                            <a href="{{ url_for('events.edit', event_id=event.id) }}" class="btn btn--primary">
                                <svg class="icon" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" aria-hidden="true">
                                    <path d="M11 4H4a2 2 0 0 0-2 2v14a2 2 0 0 0 2 2h14a2 2 0 0 0 2-2v-7"/>
                                    <path d="M18.5 2.5a2.121 2.121 0 0 1 3 3L12 15l-4 1 1-4 9.5-9.5z"/>
                                </svg>
                                Bearbeiten
                            </a>
                            {% if event.allow_ratings %}
                            <form method="POST"
                                  action="{{ url_for('events.disable_event_ratings', event_id=event.id) }}"
                                  class="form form--inline">
                                <input type="hidden" name="csrf_token" value="{{ csrf_token() }}">
                                <button type="submit" class="btn btn--outline">
                                    <svg class="icon" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" aria-hidden="true">
                                        <path d="M21 4H3"/>
                                        <path d="M7 8h10"/>
                                        <path d="M10 12h4"/>
                                        <path d="M12 16v4"/>
                                        <path d="M6 4l1 4"/>
                                        <path d="M18 4l-1 4"/>
                                    </svg>
                                    Bewertung verhindern
                                </button>
                            </form>
                            {% else %}
                            <form method="POST"
                                  action="{{ url_for('events.enable_event_ratings', event_id=event.id) }}"
                                  class="form form--inline">
                                <input type="hidden" name="csrf_token" value="{{ csrf_token() }}">
                                <button type="submit" class="btn btn--primary">
                                    <svg class="icon" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" aria-hidden="true">
                                        <path d="m9 11 3 3L22 4"/>
                                        <path d="M21 12v7a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2V5a2 2 0 0 1 2-2h11"/>
                                    </svg>
                                    Bewertung zulassen
                                </button>
                            </form>
                            {% endif %}
                            <form method="POST"
                                  action="{{ url_for('events.delete', event_id=event.id) }}"
                                  onsubmit="return confirm('Willst du dieses Event wirklich löschen? Diese Aktion kann nicht rückgängig gemacht werden.');"
                                  class="form form--inline">
                                <input type="hidden" name="csrf_token" value="{{ csrf_token() }}">
                                <button type="submit" class="btn btn--danger">
                                    <svg class="icon" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" aria-hidden="true">
                                        <polyline points="3 6 5 6 21 6"/>
                                        <path d="M19 6v14a2 2 0 0 1-2 2H7a2 2 0 0 1-2-2V6"/>
                                        <path d="M10 11v6"/>
                                        <path d="M14 11v6"/>
                                        <path d="M9 6V4a2 2 0 0 1 2-2h2a2 2 0 0 1 2 2v2"/>
                                    </svg>
                                    Event löschen
                                </button>
                            </form>
                        </div>
                    </div>
                </details>
            </div>
        </div>
        {% endif %}
        {% set tab_param = active_tab if active_tab is defined else request.args.get('tab', 'info') %}
        <div class="tabs" data-tabs>
            <nav class="tabs__nav" role="tablist">
                <a href="{{ url_for('events.detail', event_id=event.id, tab='info') }}"
                   class="tabs__tab {{ 'tabs__tab--active' if tab_param == 'info' else '' }}"
                   role="tab"
                   aria-selected="{{ 'true' if tab_param == 'info' else 'false' }}">
                    <svg class="icon" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                        <path d="M14 2H6a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V8z"/>
                        <polyline points="14 2 14 8 20 8"/>
                        <line x1="16" y1="13" x2="8" y2="13"/>
                        <line x1="16" y1="17" x2="8" y2="17"/>
                        <polyline points="10 9 9 9 8 9"/>
                    </svg>
                    Infos
                </a>
                <a href="{{ url_for('events.detail', event_id=event.id, tab='billbro') }}"
                   class="tabs__tab {{ 'tabs__tab--active' if tab_param == 'billbro' else '' }}"
                   role="tab"
                   aria-selected="{{ 'true' if tab_param == 'billbro' else 'false' }}">
                    <svg class="icon" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                        <rect x="4" y="2" width="16" height="20" rx="2" ry="2"/>
                        <line x1="8" y1="6" x2="16" y2="6"/>
                        <line x1="8" y1="10" x2="16" y2="10"/>
                        <line x1="8" y1="14" x2="16" y2="14"/>
                        <line x1="8" y1="18" x2="16" y2="18"/>
                    </svg>
                    BillBro
                </a>
                {% if event.allow_ratings %}
                <a href="{{ url_for('events.detail', event_id=event.id, tab='ratings') }}"
                   class="tabs__tab {{ 'tabs__tab--active' if tab_param == 'ratings' else '' }}"
                   role="tab"
                   aria-selected="{{ 'true' if tab_param == 'ratings' else 'false' }}">
                    <svg class="icon" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                        <polygon points="12 2 15.09 8.26 22 9.27 17 14.14 18.18 21.02 12 17.77 5.82 21.02 7 14.14 2 9.27 8.91 8.26 12 2"/>
                    </svg>
                    Bewertungen
                </a>
                {% endif %}
            </nav>

            <div class="tabs__content">
                <!-- Tab: Infos -->
                        <div class="tabs__panel {{ 'tabs__panel--active' if tab_param == 'info' else '' }}" id="tab-info" role="tabpanel">
                    <div class="card">
                        <div class="card__header">
                            <h2 class="card__title">
                                <svg class="icon" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                                    <path d="M14 2H6a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V8z"/>
                                    <polyline points="14 2 14 8 20 8"/>
                                    <line x1="16" y1="13" x2="8" y2="13"/>
                                    <line x1="16" y1="17" x2="8" y2="17"/>
                                    <polyline points="10 9 9 9 8 9"/>
                                </svg>
                                Event-Informationen
                            </h2>
                            {% set beitritt_ok = (not current_user.beitritt) or (event.datum.date() >= current_user.beitritt) %}
                            {% if beitritt_ok %}
                            <div class="card__actions">
                                <form method="POST" action="{{ url_for('events.rsvp', event_id=event.id) }}" class="status-form">
                                    <input type="hidden" name="csrf_token" value="{{ csrf_token() }}">
                                    <span class="chip-select-wrap">
                                        <select name="teilnahme" class="chip-select {% if participation %}{% if participation.teilnahme %}chip-select--yes{% else %}chip-select--no{% endif %}{% else %}chip-select--neutral{% endif %}" onchange="this.form.submit()">
                                            <option value="" disabled {% if not participation %}selected{% endif %}>Zu-/Absagen</option>
                                            <option value="true" {% if participation and participation.teilnahme %}selected{% endif %}>Zugesagt</option>
                                            <option value="false" {% if participation and not participation.teilnahme %}selected{% endif %}>Abgesagt</option>
                                        </select>
                                    </span>
                                </form>
                            </div>
                            {% endif %}
                        </div>
                        <div class="card__body">
                            <div class="info-row">
                                <span class="info-row__label">Organisator:</span>
                                <span class="info-row__value">{{ event.organisator.display_name_with_spirit }}</span>
                            </div>
                            <div class="info-row">
                                <span class="info-row__label">Teilnehmer:</span>
                                <span class="info-row__value">{{ event.get_participation_count() }} von {{ event.get_total_members_count() }} Mitgliedern</span>
                            </div>
                            
                            {% if event.restaurant or event.kueche or event.website or event.notizen or event.place_address %}
                            {% if event.restaurant %}
                            <div class="info-row">
                                <span class="info-row__label">Restaurant:</span>
                                <span class="info-row__value">{{ event.restaurant }}</span>
                            </div>
                            {% endif %}
                            {% if event.place_maps_url %}
                            <div class="info-row">
                                <span class="info-row__label">Adresse:</span>
                                <span class="info-row__value">
                                    <a href="{{ event.place_maps_url }}" class="info-row__link" target="_blank" rel="noopener">Auf Google Maps anzeigen</a>
                                </span>
                            </div>
                            {% endif %}
                            {% if event.kueche %}
                            <div class="info-row">
                                <span class="info-row__label">Küche:</span>
                                <span class="info-row__value">{{ event.kueche }}</span>
                            </div>
                            {% elif event.place_types %}
                            <div class="info-row">
                                <span class="info-row__label">Küche:</span>
                                <span class="info-row__value">
                                    {% set cuisine_types = event.place_types|map('cuisine_type_mapper')|list %}
                                    {{ cuisine_types|join(', ') if cuisine_types else 'Restaurant' }}
                                </span>
                            </div>
                            {% endif %}
                            {% if event.place_price_level %}
                            <div class="info-row">
                                <span class="info-row__label">Preislevel:</span>
                                <span class="info-row__value">{{ '€' * event.place_price_level }}</span>
                            </div>
                            {% endif %}
                            {% if event.website %}
                            <div class="info-row">
                                <span class="info-row__label">Website:</span>
                                <span class="info-row__value">
                                    <a href="{{ event.website }}" class="info-row__link" target="_blank" rel="noopener">{{ event.website }}</a>
                                </span>
                            </div>
                            {% elif event.place_website %}
                            <div class="info-row">
                                <span class="info-row__label">Website:</span>
                                <span class="info-row__value">
                                    <a href="{{ event.place_website }}" class="info-row__link" target="_blank" rel="noopener">{{ event.place_website }}</a>
                                </span>
                            </div>
                            {% endif %}
                            {% if event.notizen %}
                            <div class="info-row">
                                <span class="info-row__label">Notizen:</span>
                                <span class="info-row__value">{{ event.notizen }}</span>
                            </div>
                            {% endif %}
                            {% endif %}
                        </div>
                    </div>

                    {# Teilnahme-Card entfernt – RSVP via Dropdown im Event-Informationen-Header #}

                    <div class="card">
                        <div class="card__header">
                            <h2 class="card__title">
                                <svg class="icon" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                                    <path d="M17 21v-2a4 4 0 0 0-4-4H5a4 4 0 0 0-4 4v2"/>
                                    <circle cx="9" cy="7" r="4"/>
                                    <path d="M23 21v-2a4 4 0 0 0-3-3.87"/>
                                    <path d="M16 3.13a4 4 0 0 1 0 7.75"/>
                                </svg>
                                Teilnehmer-Übersicht
                            </h2>
                        </div>
                        <div class="card__body">
                            {% for member in all_members %}
                            {% if not member.beitritt or member.beitritt <= event.datum.date() %}
                                {% set member_participation = participations|selectattr('member_id', 'equalto', member.id)|first %}
                                <div class="info-row">
                                    <span class="info-row__label">{{ member.display_name_with_spirit }}</span>
                                    <span class="info-row__value">
                                        {% if member_participation %}
                                            {% if member_participation.teilnahme %}
                                                <span class="participation-status participation-status--confirmed">Teilnehmer</span>
                                            {% else %}
                                                <span class="participation-status participation-status--declined">Absage</span>
                                            {% endif %}
                                        {% else %}
                                            <span class="participation-status participation-status--pending">Keine Antwort</span>
                                        {% endif %}
                                    </span>
                                </div>
                            {% endif %}
                            {% endfor %}
                        </div>
                    </div>
                </div>

                <!-- Tab: BillBro -->
                        <div class="tabs__panel {{ 'tabs__panel--active' if tab_param == 'billbro' else '' }}" id="tab-billbro" role="tabpanel">
                    {% set is_organizer = event.organisator_id == current_user.id %}
                    {% set has_bill = event.rechnungsbetrag_rappen is not none %}
                    {% set has_final = event.gesamtbetrag_rappen is not none %}
                    {% set can_access_billbro = (participation and participation.teilnahme) or is_organizer %}
                    {% if can_access_billbro %}
                    <!-- BillBro: Neue V2-Struktur -->

                    {# 1) Dein Anteil (nur nach finalem Gesamtbetrag) #}
                    {% if has_final %}
                    <div class="card" id="billbro-share">
                        <div class="card__header">
                            <h2 class="card__title">
                                <svg class="icon" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" aria-hidden="true">
                                    <path d="M12 2v20" />
                                    <path d="M17 5H9.5a3.5 3.5 0 0 0 0 7H14a3.5 3.5 0 1 1 0 7H6" />
                                </svg>
                                Dein Anteil
                            </h2>
                        </div>
                        <div class="card__body">
                            {% if participation and participation.esstyp %}
                            <div class="info-row">
                                <span class="info-row__label">Dein Anteil</span>
                                <span class="info-row__value">
                                    {% if participation.esstyp.name == 'SPARSAM' and event.betrag_sparsam_rappen %}
                                        {{ "%.2f"|format(event.betrag_sparsam_rappen / 100) }} CHF (Sparsam)
                                    {% elif participation.esstyp.name == 'NORMAL' and event.betrag_normal_rappen %}
                                        {{ "%.2f"|format(event.betrag_normal_rappen / 100) }} CHF (Normal)
                                    {% elif participation.esstyp.name == 'ALLIN' and event.betrag_allin_rappen %}
                                        {{ "%.2f"|format(event.betrag_allin_rappen / 100) }} CHF (All-In)
                                    {% else %}
                                        Noch nicht berechnet
                                    {% endif %}
                                </span>
                            </div>
                            {% else %}
                            <p class="text-muted">Bitte wähle deinen Ess-Typ.</p>
                            {% endif %}
                        </div>
                    </div>

                    <div class="card">
                        <div class="card__header">
                            <h2 class="card__title">
                                <svg class="icon" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" aria-hidden="true">
                                    <circle cx="11" cy="11" r="8"/>
                                    <path d="m21 21-4.35-4.35"/>
                                </svg>
                                Rechnungsübersicht
                            </h2>
                        </div>
                        <div class="card__body">
                            <div class="info-row">
                                <span class="info-row__label">Gesamtbetrag</span>
                                <span class="info-row__value">{{ "%.2f"|format(event.gesamtbetrag_rappen / 100) }} CHF</span>
                            </div>
                            <div class="info-row">
                                <span class="info-row__label">Trinkgeld</span>
                                <span class="info-row__value">
                                    {{ "%.2f"|format((event.gesamtbetrag_rappen - event.rechnungsbetrag_rappen) / 100) }} CHF
                                    <small>({{ "%.1f"|format((event.gesamtbetrag_rappen - event.rechnungsbetrag_rappen) / event.rechnungsbetrag_rappen * 100) }}%)</small>
                                </span>
                            </div>
                            <div class="info-row">
                                <span class="info-row__label">Anteil Sparsam</span>
                                <span class="info-row__value">{{ "%.2f"|format(event.betrag_sparsam_rappen / 100) if event.betrag_sparsam_rappen else "Nicht berechnet" }} CHF</span>
                            </div>
                            <div class="info-row">
                                <span class="info-row__label">Anteil Normal</span>
                                <span class="info-row__value">{{ "%.2f"|format(event.betrag_normal_rappen / 100) if event.betrag_normal_rappen else "Nicht berechnet" }} CHF</span>
                            </div>
                            <div class="info-row">
                                <span class="info-row__label">Anteil All-In</span>
                                <span class="info-row__value">{{ "%.2f"|format(event.betrag_allin_rappen / 100) if event.betrag_allin_rappen else "Nicht berechnet" }} CHF</span>
                            </div>
                        </div>
                        {% if is_organizer %}
                        <div class="card__footer">
                            <form method="POST" action="{{ url_for('billbro.undo_final', event_id=event.id) }}" class="form">
                                <input type="hidden" name="csrf_token" value="{{ csrf_token() }}">
                                <button type="submit" class="btn btn--danger" onclick="return confirm('Finalisierung aufheben? Anteile und Gesamtbetrag werden wieder bearbeitbar.')">
                                    <svg class="icon" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                                        <path d="M3 7v6a9 9 0 0 0 18 0V7" />
                                        <path d="M12 4v9" />
                                        <path d="m15 10-3 3-3-3" />
                                    </svg>
                                    Finalisierung aufheben
                                </button>
                            </form>
                        </div>
                        {% endif %}
                    </div>
                    {% endif %}

                    {# 2) Schätzungsrangliste (sobald Rechnungsbetrag gesetzt) #}
                    {% if has_bill %}
                    {% set ranked = event.participations
                            | selectattr('teilnahme','equalto', True)
                            | rejectattr('guess_bill_amount_rappen', 'equalto', none)
                            | list %}
                    {% set ranked = ranked|sort(attribute='diff_amount_rappen') %}
                    <div class="card">
                        <div class="card__header">
                            <h2 class="card__title">
                                <svg class="icon" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" aria-hidden="true">
                                    <use href="/static/icons/lucide-sprite.svg#medal"></use>
                                </svg>
                                Schätzungsrangliste
                            </h2>
                        </div>
                        <div class="card__body">
                            {% for p in ranked %}
                            <div class="info-row">
                                <span class="info-row__label">{{ loop.index }}. {{ p.member.display_name_with_spirit }}</span>
                                <span class="info-row__value">
                                    {{ "%.2f"|format((p.guess_bill_amount_rappen or 0)/100) }} CHF
                                    {% if p.diff_amount_rappen is not none %}
                                    <small class="ranking-diff">(Δ {{ "%.2f"|format(p.diff_amount_rappen/100) }} CHF)</small>
                                    {% endif %}
                                </span>
                            </div>
                            {% endfor %}
                        </div>
                    </div>
                    {% endif %}

                    <!-- 3) Deine Schätzung / Neue Schätzung als eigenständige Cards -->
                    {% if participation.has_guess %}
                    <div class="card">
                        <div class="card__header">
                            <h2 class="card__title">
                                <svg class="icon" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                                    <polyline points="20 6 9 17 4 12"/>
                                </svg>
                                Deine Schätzung
                            </h2>
                        </div>
                        <div class="card__body">
                            <div class="info-row">
                                <span class="info-row__label">Schätzung</span>
                                <span class="info-row__value">{{ participation.display_guess }}</span>
                            </div>
                            <div class="info-row">
                                <span class="info-row__label">Ess-Typ</span>
                                <span class="info-row__value">{{ participation.esstyp.value if participation.esstyp else 'Nicht gewählt' }}</span>
                            </div>
                        </div>
                        <div class="card__footer">
                            {% if not event.billbro_closed %}
                            <form method="POST" action="{{ url_for('billbro.update_guess', event_id=event.id) }}" class="form">
                                <input type="hidden" name="csrf_token" value="{{ csrf_token() }}">
                                <button type="submit" class="btn btn--outline">
                                    <svg class="icon" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                                        <path d="M11 4H4a2 2 0 0 0-2 2v14a2 2 0 0 0 2 2h14a2 2 0 0 0 2-2v-7"/>
                                        <path d="M18.5 2.5a2.121 2.121 0 0 1 3 3L12 15l-4 1 1-4 9.5-9.5z"/>
                                    </svg>
                                    Schätzung bearbeiten
                                </button>
                            </form>
                            {% else %}
                            <p class="text-muted">BillBro ist abgeschlossen – keine Änderungen mehr möglich.</p>
                            {% endif %}
                        </div>
                    </div>
                    {% else %}
                    <div class="card">
                        <div class="card__header">
                            <h2 class="card__title">
                                <svg class="icon" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" aria-hidden="true">
                                    <circle cx="12" cy="12" r="10" />
                                    <circle cx="12" cy="12" r="6" />
                                    <circle cx="12" cy="12" r="2" />
                                    <path d="m22 2-7.5 7.5" />
                                    <path d="m16 2 6 6" />
                                    <path d="M22 8h-4" />
                                    <path d="M20 2v4" />
                                </svg>
                                Neue Schätzung abgeben
                            </h2>
                        </div>
                        <div class="card__body">
                            {% if not event.billbro_closed %}
                            {% if form is defined %}
                                <form method="POST" action="{{ url_for('billbro.compute', event_id=event.id) }}" class="form">
                                    <input type="hidden" name="csrf_token" value="{{ csrf_token() }}">
                                    
                                    <div class="form-field">
                                        {{ form.esstyp.label(class_="form-field__label") }}
                                        {{ form.esstyp(class_="form-field__select") }}
                                        {% if form.esstyp.errors %}
                                        <span class="form-field__error">{{ form.esstyp.errors[0] }}</span>
                                        {% endif %}
                                    </div>
                                    
                                    <div class="form-field">
                                        {{ form.guess_amount.label(class_="form-field__label") }}
                                        {{ form.guess_amount(class_="form-field__input", placeholder="z.B. 45.50") }}
                                        {% if form.guess_amount.errors %}
                                        <span class="form-field__error">{{ form.guess_amount.errors[0] }}</span>
                                        {% endif %}
                                    </div>
                                    
                                    <div class="form-actions">
                                        <button type="submit" class="btn btn--primary">
                                            <svg class="icon" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                                                <polyline points="20 6 9 17 4 12"/>
                                            </svg>
                                            Schätzung abgeben
                                        </button>
                                    </div>
                                </form>
                            {% else %}
                                <p class="text-muted">Formular nicht verfügbar.</p>
                            {% endif %}
                            {% else %}
                            <p class="text-muted">BillBro ist abgeschlossen – keine neuen Schätzungen möglich.</p>
                            {% endif %}
                        </div>
                    </div>
                    {% endif %}

                    {% if is_organizer %}
                    <!-- Organizer: Anwesenheit & Schätzungen -->
                    <div class="card">
                        <div class="card__header">
                            <h2 class="card__title">
                                <svg class="icon" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                                    <path d="M16 21v-2a4 4 0 0 0-4-4H6a4 4 0 0 0-4 4v2"/>
                                    <circle cx="9" cy="7" r="4"/>
                                    <path d="M22 21v-2a4 4 0 0 0-3-3.87"/>
                                    <path d="M16 3.13a4 4 0 0 1 0 7.75"/>
                                </svg>
                                Anwesenheits-Check
                            </h2>
                        </div>
                        <div class="card__body">
                            <p class="text-muted">Bestätige, wer wirklich anwesend ist, bevor du die Rechnung eingibst.</p>
                            <div class="card-section card-section--subtle">
                                <div class="card-section__body">
                                    {# Zusagen zuerst #}
                                    {% for member in all_members %}
                                    {% set member_participation = event.participations|selectattr('member_id', 'equalto', member.id)|first %}
                                    {% if member_participation and member_participation.teilnahme %}
                                    <div class="info-row">
                                        <span class="info-row__label">{{ member.display_name_with_spirit }}</span>
                                        <div class="info-row__value info-row__value--actions">
                                            {{ member_participation.display_guess if member_participation.has_guess else 'Wartet auf Schätzung' }}
                                            {% if not member_participation.has_guess %}
                                            <form method="POST" action="{{ url_for('billbro.mark_absent', event_id=event.id, member_id=member.id) }}" class="form">
                                                <input type="hidden" name="csrf_token" value="{{ csrf_token() }}">
                                                <button type="submit" class="btn btn--outline btn--sm" onclick="return confirm('{{ member.display_name_with_spirit }} ist nicht da?')">Nicht da</button>
                                            </form>
                                            {% endif %}
                                        </div>
                                    </div>
                                    {% endif %}
                                    {% endfor %}

                                    {# Abgesagt #}
                                    {% for member in all_members %}
                                    {% set member_participation = event.participations|selectattr('member_id', 'equalto', member.id)|first %}
                                    {% if member_participation and not member_participation.teilnahme %}
                                    <div class="info-row">
                                        <span class="info-row__label">{{ member.display_name_with_spirit }}</span>
                                        <div class="info-row__value info-row__value--actions">Abgesagt</div>
                                    </div>
                                    {% endif %}
                                    {% endfor %}

                                    {# Keine Antwort #}
                                    {% for member in all_members %}
                                    {% set member_participation = event.participations|selectattr('member_id', 'equalto', member.id)|first %}
                                    {% if not member_participation %}
                                    <div class="info-row">
                                        <span class="info-row__label">{{ member.display_name_with_spirit }}</span>
                                        <div class="info-row__value info-row__value--actions">Keine Antwort</div>
                                    </div>
                                    {% endif %}
                                    {% endfor %}
                                </div>
                            </div>
                        </div>
                        {% set total_attending = event.participations|selectattr('teilnahme','equalto',True)|list %}
                        {% set pending_guesses = total_attending|selectattr('guess_bill_amount_rappen','equalto',None)|list %}
                        <div class="card__footer">
                            {% if event.billbro_closed %}
                            <form method="POST" action="{{ url_for('billbro.toggle_billbro_status', event_id=event.id) }}" class="form">
                                <input type="hidden" name="csrf_token" value="{{ csrf_token() }}">
                                <button type="submit" class="btn btn--outline">
                                    <svg class="icon" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                                        <path d="M3 12h18"/>
                                        <path d="M12 3v18"/>
                                    </svg>
                                    Schätzrunde öffnen
                                </button>
                            </form>
                            {% elif pending_guesses|length > 0 %}
                            <span class="text-muted">Warten auf Schätzungen ({{ pending_guesses|length }})</span>
                            {% else %}
                            <form method="POST" action="{{ url_for('billbro.toggle_billbro_status', event_id=event.id) }}" class="form">
                                <input type="hidden" name="csrf_token" value="{{ csrf_token() }}">
                                <button type="submit" class="btn btn--primary">
                                    <svg class="icon" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                                        <polyline points="20 6 9 17 4 12"/>
                                    </svg>
                                    Schätzrunde schließen
                                </button>
                            </form>
                            {% endif %}
                        </div>
                    </div>
                    {% endif %}

                    <!-- Rechnung & Berechnung als eigenständige Cards -->

                    {% if is_organizer and event.billbro_closed and not has_final %}
                    <div class="card">
                        <div class="card__header">
                            <h2 class="card__title">Rechnungsbetrag eingeben</h2>
                        </div>
                        <div class="card__body">
                            <form method="POST" action="{{ url_for('billbro.enter_bill', event_id=event.id) }}" class="form">
                                <input type="hidden" name="csrf_token" value="{{ csrf_token() }}">
                                <div class="form-field">
                                    <label class="form-field__label" for="rechnungsbetrag">Rechnungsbetrag (CHF)</label>
                                    <input type="number" id="rechnungsbetrag" name="rechnungsbetrag" step="0.01" min="0" class="form-field__input" required>
                                </div>
                                <div class="form-actions">
                                    <button type="submit" class="btn btn--primary">
                                        <svg class="icon" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                                            <path d="M12 3v18"/>
                                            <path d="M17 8H9a3 3 0 0 0 0 6h6a3 3 0 0 1 0 6H6"/>
                                        </svg>
                                        Berechnen
                                    </button>
                                </div>
                            </form>
                        </div>
                    </div>
                    {% endif %}

                    {% if has_bill and not has_final %}
                    <div class="card" id="billbro-tip-suggestion">
                        <div class="card__header">
                            <h2 class="card__title">Vorschlag Trinkgeld</h2>
                        </div>
                        <div class="card__body">
                            <div class="info-row">
                                <span class="info-row__label">Rechnungsbetrag</span>
                                <span class="info-row__value">{{ "%.2f"|format(event.rechnungsbetrag_rappen / 100) }} CHF</span>
                            </div>
                            <div class="info-row">
                                <span class="info-row__label">Trinkgeld (7%)</span>
                                <span class="info-row__value">{{ "%.2f"|format(event.trinkgeld_rappen / 100) }} CHF</span>
                            </div>
                            <div class="info-row">
                                <span class="info-row__label">Vorschlag Gesamtbetrag</span>
                                <span class="info-row__value">{{ "%.2f"|format(((event.rechnungsbetrag_rappen + event.trinkgeld_rappen + 999) // 1000 * 1000) / 100) }} CHF</span>
                            </div>
                        </div>
                        {% if is_organizer and not has_final %}
                        <div class="card__footer">
                            <form method="POST" action="{{ url_for('billbro.accept_suggested_total', event_id=event.id) }}" class="form">
                                <input type="hidden" name="csrf_token" value="{{ csrf_token() }}">
                                <button type="submit" class="btn btn--success">
                                    <svg class="icon" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                                        <polyline points="20 6 9 17 4 12"/>
                                    </svg>
                                    Eingaben speichern
                                </button>
                            </form>
                            <button type="button" class="btn btn--outline" data-manual-toggle="manual-total">
                                <svg class="icon" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                                    <path d="M4 7h16"/>
                                    <path d="M10 11h10"/>
                                    <path d="M4 15h16"/>
                                </svg>
                                Gesamtbetrag anpassen
                            </button>
                        </div>
                        {% endif %}
                    </div>

                    {% if is_organizer and not has_final %}
                    <div class="card" id="manual-total" hidden>
                        <div class="card__header">
                            <h2 class="card__title">Vorschlag bearbeiten</h2>
                        </div>
                        <div class="card__body">
                            <form method="POST" action="{{ url_for('billbro.set_total', event_id=event.id) }}" class="form">
                                <input type="hidden" name="csrf_token" value="{{ csrf_token() }}">
                                <div class="form-field">
                                    <label class="form-field__label" for="gesamtbetrag_manual">Gewünschter Gesamtbetrag (CHF)</label>
                                    <input type="number" id="gesamtbetrag_manual" name="gesamtbetrag_manual" step="0.01" min="0" class="form-field__input" value="{{ event.gesamtbetrag_rappen / 100 if event.gesamtbetrag_rappen else '' }}" placeholder="z.B. {{ '%.0f'|format(((event.rechnungsbetrag_rappen + event.trinkgeld_rappen + 999) // 1000 * 1000) / 100) }}">
                                </div>
                                <div class="form-actions">
                                    <button type="submit" class="btn btn--primary">
                                        <svg class="icon" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                                            <polyline points="20 6 9 17 4 12"/>
                                        </svg>
                                        Gesamtbetrag speichern
                                    </button>
                                </div>
                            </form>
                        </div>
                    </div>
                    {% endif %}

                    {% if has_final %}
                    <div class="card">
                        <div class="card__header">
                            <h2 class="card__title">Rechnungsübersicht</h2>
                        </div>
                        <div class="card__body">
                            <div class="info-row">
                                <span class="info-row__label">Gesamtbetrag</span>
                                <span class="info-row__value">{{ "%.2f"|format(event.gesamtbetrag_rappen / 100) }} CHF</span>
                            </div>
                            <div class="info-row">
                                <span class="info-row__label">Trinkgeld</span>
                                <span class="info-row__value">
                                    {{ "%.2f"|format((event.gesamtbetrag_rappen - event.rechnungsbetrag_rappen) / 100) }} CHF
                                    <small>({{ "%.1f"|format((event.gesamtbetrag_rappen - event.rechnungsbetrag_rappen) / event.rechnungsbetrag_rappen * 100) }}%)</small>
                                </span>
                            </div>
                            <div class="info-row">
                                <span class="info-row__label">Anteil Sparsam</span>
                                <span class="info-row__value">{{ "%.2f"|format(event.betrag_sparsam_rappen / 100) if event.betrag_sparsam_rappen else "Nicht berechnet" }} CHF</span>
                            </div>
                            <div class="info-row">
                                <span class="info-row__label">Anteil Normal</span>
                                <span class="info-row__value">{{ "%.2f"|format(event.betrag_normal_rappen / 100) if event.betrag_normal_rappen else "Nicht berechnet" }} CHF</span>
                            </div>
                            <div class="info-row">
                                <span class="info-row__label">Anteil All-In</span>
                                <span class="info-row__value">{{ "%.2f"|format(event.betrag_allin_rappen / 100) if event.betrag_allin_rappen else "Nicht berechnet" }} CHF</span>
                            </div>
                        </div>
                        {% if is_organizer %}
                        <div class="card__footer" style="justify-content: flex-end;">
                            <form method="POST" action="{{ url_for('billbro.undo_final', event_id=event.id) }}" class="form" style="margin:0;">
                                <input type="hidden" name="csrf_token" value="{{ csrf_token() }}">
                                <button type="submit" class="btn btn--outline" onclick="return confirm('Finalisierung aufheben? Anteile und Gesamtbetrag werden wieder bearbeitbar.')">
                                    <svg class="icon" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                                        <path d="M10 2h4"/>
                                        <path d="M12 2v20"/>
                                        <path d="m18 8 4 4-4 4"/>
                                        <path d="m6 16-4-4 4-4"/>
                                    </svg>
                                    Finalisierung aufheben
                                </button>
                            </form>
                        </div>
                        {% endif %}
                    </div>
                    {% endif %}

                    {% if is_organizer and has_final %}
                    <div class="page-actions page-actions--right" style="margin-top: var(--space-4);">
                        <form method="POST" action="{{ url_for('billbro.reset_bill', event_id=event.id) }}" class="form" style="margin:0;">
                            <input type="hidden" name="csrf_token" value="{{ csrf_token() }}">
                            <button type="submit" class="btn btn--danger" onclick="return confirm('BillBro neu starten? Alle Beträge werden zurückgesetzt.')">
                                <svg class="icon" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                                    <path d="M21 12a9 9 0 1 1-2.64-6.36"/>
                                    <polyline points="21 3 21 9 15 9"/>
                                </svg>
                                Neu starten
                            </button>
                        </form>
                    </div>
                    {% endif %}
                    {% endif %}

                    {% else %}
                    <div class="card">
                        <div class="card__body">
                            <p>BillBro steht nur Teilnehmenden zur Verfügung.</p>
                        </div>
                    </div>
                    {% endif %}
                </div>

                {% if event.allow_ratings %}
                <!-- Tab: Bewertungen -->
                        <div class="tabs__panel {{ 'tabs__panel--active' if tab_param == 'ratings' else '' }}" id="tab-ratings" role="tabpanel">
                    {% with messages = get_flashed_messages(with_categories=true) %}
                    {% if messages %}
                    <div class="card" style="margin-bottom: var(--space-4);">
                        <div class="card__body">
                            {% for category, message in messages %}
                                <div class="alert alert--{{ 'error' if category == 'error' else ('success' if category == 'success' else 'info') }}">
                                    <div class="alert__content">
                                        <div class="alert__message">{{ message }}</div>
                                    </div>
                                </div>
                            {% endfor %}
                        </div>
                    </div>
                    {% endif %}
                    {% endwith %}

                    <div class="card">
                        <div class="card__header">
                            <h2 class="card__title">
                                <svg class="icon" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                                    <polygon points="12 2 15.09 8.26 22 9.27 17 14.14 18.18 21.02 12 17.77 5.82 21.02 7 14.14 2 9.27 8.91 8.26 12 2"/>
                                </svg>
                                Gesamtbewertung
                            </h2>
                        </div>
                        <div class="card__body">
                            {% if average_ratings.count > 0 %}
                            <div class="info-row">
                                <span class="info-row__label">Gesamt</span>
                                <span class="info-row__value">{{ average_ratings.overall }}/5 ({{ average_ratings.count }})</span>
                            </div>
                            <div class="info-row">
                                <span class="info-row__label">Essen</span>
                                <span class="info-row__value">{{ average_ratings.food }}/5</span>
                            </div>
                            <div class="info-row">
                                <span class="info-row__label">Getränke</span>
                                <span class="info-row__value">{{ average_ratings.drinks }}/5</span>
                            </div>
                            <div class="info-row">
                                <span class="info-row__label">Service</span>
                                <span class="info-row__value">{{ average_ratings.service }}/5</span>
                            </div>
                            {% else %}
                            <p>Für dieses Event liegen noch keine Bewertungen vor.</p>
                            {% endif %}
                        </div>
                    </div>

                    {% if can_rate %}
                        {% if user_rating %}
                        <div class="card">
                            <div class="card__header">
                                <h2 class="card__title">
                                    <svg class="icon" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                                        <path d="M12 2l2.09 6.26L20 9.27l-5 4.87L16.18 21 12 17.77 7.82 21 9 14.14l-5-4.87 5.91-.99L12 2z"></path>
                                    </svg>
                                    Deine Bewertung
                                </h2>
                            </div>
                            <div class="card__body">
                                {% if rating_edit_mode %}
                                <form method="POST" action="{{ url_for('ratings.edit_rating', event_id=event.id) }}" class="form">
                                    <input type="hidden" name="csrf_token" value="{{ csrf_token() }}">
                                    <div class="form-row">
                                        <div class="form-field">
                                            <label class="form-field__label" for="food_rating_edit">Essen</label>
                                            <select id="food_rating_edit" name="food_rating" class="form-field__select" required>
                                                {% for score in [5,4,3,2,1] %}
                                                <option value="{{ score }}" {% if user_rating.food_rating == score %}selected{% endif %}>{{ score }} / 5</option>
                                                {% endfor %}
                                            </select>
                                        </div>
                                        <div class="form-field">
                                            <label class="form-field__label" for="drinks_rating_edit">Getränke</label>
                                            <select id="drinks_rating_edit" name="drinks_rating" class="form-field__select" required>
                                                {% for score in [5,4,3,2,1] %}
                                                <option value="{{ score }}" {% if user_rating.drinks_rating == score %}selected{% endif %}>{{ score }} / 5</option>
                                                {% endfor %}
                                            </select>
                                        </div>
                                        <div class="form-field">
                                            <label class="form-field__label" for="service_rating_edit">Service</label>
                                            <select id="service_rating_edit" name="service_rating" class="form-field__select" required>
                                                {% for score in [5,4,3,2,1] %}
                                                <option value="{{ score }}" {% if user_rating.service_rating == score %}selected{% endif %}>{{ score }} / 5</option>
                                                {% endfor %}
                                            </select>
                                        </div>
                                    </div>
                                    <div class="form-field">
                                        <label class="form-field__label" for="highlights_edit">Highlights (optional)</label>
                                        <textarea id="highlights_edit" name="highlights" class="form-field__textarea" rows="3" placeholder="Was war besonders gut?">{{ user_rating.highlights or '' }}</textarea>
                                    </div>
                                    <div class="form-actions">
                                        <a class="btn btn--outline" href="{{ url_for('events.detail', event_id=event.id, tab='ratings') }}">Abbrechen</a>
                                        <button type="submit" class="btn btn--primary">
                                            <svg class="icon" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                                                <polygon points="12 2 15.09 8.26 22 9.27 17 14.14 18.18 21.02 12 17.77 5.82 21.02 7 14.14 2 9.27 8.91 8.26 12 2"/>
                                            </svg>
                                            Änderungen speichern
                                        </button>
                                    </div>
                                </form>
                                {% else %}
                                <div class="info-row">
                                    <span class="info-row__label">Durchschnitt</span>
                                    <span class="info-row__value">{{ user_rating.average_rating }}/5</span>
                                </div>
                                <div class="info-row">
                                    <span class="info-row__label">Essen</span>
                                    <span class="info-row__value">{{ user_rating.food_rating }}/5</span>
                                </div>
                                <div class="info-row">
                                    <span class="info-row__label">Getränke</span>
                                    <span class="info-row__value">{{ user_rating.drinks_rating }}/5</span>
                                </div>
                                <div class="info-row">
                                    <span class="info-row__label">Service</span>
                                    <span class="info-row__value">{{ user_rating.service_rating }}/5</span>
                                </div>
                                {% if user_rating.highlights %}
                                <p style="margin-top: var(--space-3); color: var(--color-text-secondary);">
                                    {{ user_rating.highlights }}
                                </p>
                                {% endif %}
                                {% endif %}
                            </div>
                            <div class="card__footer">
                                {% if not rating_edit_mode %}
                                <a href="{{ url_for('events.detail', event_id=event.id, tab='ratings', edit_rating='1') }}" class="btn btn--primary">
                                    <svg class="icon" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                                        <path d="M11 4H4a2 2 0 0 0-2 2v14a2 2 0 0 0 2 2h14a2 2 0 0 0 2-2v-7"/>
                                        <path d="M18.5 2.5a2.121 2.121 0 0 1 3 3L12 15l-4 1 1-4 9.5-9.5z"/>
                                    </svg>
                                    Bewertung bearbeiten
                                </a>
                                {% endif %}
                                <form method="POST" action="{{ url_for('ratings.delete_rating', event_id=event.id) }}" class="form" style="margin:0;">
                                    <input type="hidden" name="csrf_token" value="{{ csrf_token() }}">
                                    <button type="submit" class="btn btn--danger" onclick="return confirm('Bewertung wirklich löschen?');">
                                        <svg class="icon" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                                            <polyline points="3 6 5 6 21 6"/>
                                            <path d="M19 6v14a2 2 0 0 1-2 2H7a2 2 0 0 1-2-2V6"/>
                                            <path d="M10 11v6"/>
                                            <path d="M14 11v6"/>
                                            <path d="M9 6V4a2 2 0 0 1 2-2h2a2 2 0 0 1 2 2v2"/>
                                        </svg>
                                        Löschen
                                    </button>
                                </form>
                            </div>
                        </div>
                        {% endif %}
                        {% if not user_rating %}
                        <div class="card">
                            <div class="card__header">
                                <h2 class="card__title">
                                    <svg class="icon" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                                        <polygon points="12 2 15.09 8.26 22 9.27 17 14.14 18.18 21.02 12 17.77 5.82 21.02 7 14.14 2 9.27 8.91 8.26 12 2"/>
                                    </svg>
                                    Deine Bewertung
                                </h2>
                            </div>
                            <div class="card__body">
                                <form method="POST" action="{{ url_for('ratings.rate_event', event_id=event.id) }}" class="form">
                                    <input type="hidden" name="csrf_token" value="{{ csrf_token() }}">
                                    <div class="form-row">
                                        <div class="form-field">
                                            <label class="form-field__label" for="food_rating_new">Essen</label>
                                            <select id="food_rating_new" name="food_rating" class="form-field__select" required>
                                                {% for score in [5,4,3,2,1] %}
                                                <option value="{{ score }}">{{ score }} / 5</option>
                                                {% endfor %}
                                            </select>
                                        </div>
                                        <div class="form-field">
                                            <label class="form-field__label" for="drinks_rating_new">Getränke</label>
                                            <select id="drinks_rating_new" name="drinks_rating" class="form-field__select" required>
                                                {% for score in [5,4,3,2,1] %}
                                                <option value="{{ score }}">{{ score }} / 5</option>
                                                {% endfor %}
                                            </select>
                                        </div>
                                        <div class="form-field">
                                            <label class="form-field__label" for="service_rating_new">Service</label>
                                            <select id="service_rating_new" name="service_rating" class="form-field__select" required>
                                                {% for score in [5,4,3,2,1] %}
                                                <option value="{{ score }}">{{ score }} / 5</option>
                                                {% endfor %}
                                            </select>
                                        </div>
                                    </div>
                                    <div class="form-field">
                                        <label class="form-field__label" for="highlights_new">Highlights (optional)</label>
                                        <textarea id="highlights_new" name="highlights" class="form-field__textarea" rows="3" placeholder="Was war besonders gut?"></textarea>
                                    </div>
                                    <div class="form-actions">
                                        <button type="submit" class="btn btn--primary">
                                            <svg class="icon" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                                                <polygon points="12 2 15.09 8.26 22 9.27 17 14.14 18.18 21.02 12 17.77 5.82 21.02 7 14.14 2 9.27 8.91 8.26 12 2"/>
                                            </svg>
                                            Bewertung speichern
                                        </button>
                                    </div>
                                </form>
                            </div>
                        </div>
                        {% endif %}
                    {% else %}
                    <div class="card">
                        <div class="card__body">
                            <p>Bewertungen stehen nur Teilnehmenden oder Organisatoren zur Verfügung.</p>
                        </div>
                    </div>
                    {% endif %}

                    <div class="card">
                        <div class="card__header">
                            <h2 class="card__title">
                                <svg class="icon" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                                    <line x1="18" y1="20" x2="18" y2="10"/>
                                    <line x1="12" y1="20" x2="12" y2="4"/>
                                    <line x1="6" y1="20" x2="6" y2="14"/>
                                </svg>
                                Bewertungen der anderen Teilnehmer
                            </h2>
                        </div>
                        <div class="card__body">
                            {% if other_ratings %}
                                {% for rating in other_ratings %}
                                <div class="rating-entry" style="margin-bottom: var(--space-4);">
                                    <div class="info-row">
                                    <span class="info-row__label">{{ rating.participant.display_name_with_spirit if rating.participant else 'Mitglied' }}</span>
                                    <span class="info-row__value">{{ rating.average_rating }}/5</span>
                                    </div>
                                    <div class="info-row">
                                        <span class="info-row__label">Essen</span>
                                        <span class="info-row__value">{{ rating.food_rating }}/5</span>
                                    </div>
                                    <div class="info-row">
                                        <span class="info-row__label">Getränke</span>
                                        <span class="info-row__value">{{ rating.drinks_rating }}/5</span>
                                    </div>
                                    <div class="info-row">
                                        <span class="info-row__label">Service</span>
                                        <span class="info-row__value">{{ rating.service_rating }}/5</span>
                                    </div>
                                    {% if rating.highlights %}
                                    <p style="margin-top: var(--space-3); color: var(--color-text-secondary);">
                                        {{ rating.highlights }}
                                    </p>
                                    {% endif %}
                                </div>
                                {% endfor %}
                            {% else %}
                            <p>Noch keine weiteren Bewertungen vorhanden.</p>
                            {% endif %}
                        </div>
                    </div>
                </div>
                {% endif %}
            </div>
        </div>

    </div>
</div>

<script>
document.addEventListener('DOMContentLoaded', function() {
    // Tabs (JS-basiert)
    const tabContainer = document.querySelector('[data-tabs]');
    if (tabContainer) {
        const tabs = Array.from(tabContainer.querySelectorAll('[data-tab-target]'));
        const panels = Array.from(tabContainer.querySelectorAll('.tabs__panel'));

        const activate = (targetId) => {
            tabs.forEach((t) => {
                const active = t.getAttribute('data-tab-target') === targetId;
                t.classList.toggle('tabs__tab--active', active);
                t.setAttribute('aria-selected', active ? 'true' : 'false');
            });
            panels.forEach((p) => {
                const active = p.id === targetId;
                p.classList.toggle('tabs__panel--active', active);
            });
        };

        tabContainer.addEventListener('click', (e) => {
            const btn = e.target.closest('[data-tab-target]');
            if (!btn) return;
            activate(btn.getAttribute('data-tab-target'));
        });
    }

    // Handle RSVP reminder button
    const rsvpReminderBtn = document.querySelector('.send-rsvp-reminder-btn');
    if (rsvpReminderBtn) {
        rsvpReminderBtn.addEventListener('click', function() {
            if (confirm('Push-Benachrichtigung an alle Mitglieder senden, die noch nicht geantwortet haben?\n\nHinweis: Nur Mitglieder mit aktivierten Push-Benachrichtigungen erhalten die Erinnerung.')) {
                const eventId = this.getAttribute('data-event-id');
                const form = document.createElement('form');
                form.method = 'POST';
                form.action = '/events/' + eventId + '/send_rsvp_reminder';
                
                const csrf = document.createElement('input');
                csrf.type = 'hidden';
                csrf.name = 'csrf_token';
                csrf.value = '{{ csrf_token() }}';
                form.appendChild(csrf);
                
                document.body.appendChild(form);
                form.submit();
            }
        });
    }
    
    // Handle delete event buttons
    document.querySelectorAll('.delete-event-btn').forEach(function(button) {
        button.addEventListener('click', function() {
            const eventId = this.getAttribute('data-event-id');
            const eventTitle = this.getAttribute('data-event-title');
            
            if (confirm('Möchtest du das Event "' + eventTitle + '" wirklich löschen? Diese Aktion kann nicht rückgängig gemacht werden.')) {
                const form = document.createElement('form');
                form.method = 'POST';
                form.action = '/events/' + eventId + '/delete';
                
                const csrf = document.createElement('input');
                csrf.type = 'hidden';
                csrf.name = 'csrf_token';
                csrf.value = '{{ csrf_token() }}';
                form.appendChild(csrf);
                
                document.body.appendChild(form);
                form.submit();
            }
        });
    });

    // Manuelle Gesamtbetragsanpassung ein-/ausblenden
    document.querySelectorAll('[data-manual-toggle]').forEach((button) => {
        const targetId = button.getAttribute('data-manual-toggle');
        const target = document.getElementById(targetId);
        if (!target) return;

        button.addEventListener('click', () => {
            const willShow = target.hasAttribute('hidden');
            if (willShow) {
                target.removeAttribute('hidden');
                target.scrollIntoView({ behavior: 'smooth', block: 'start' });
            } else {
                target.setAttribute('hidden', '');
            }
        });
    });

    // Scroll to anchor targets for BillBro (smooth)
    const hash = window.location.hash ? window.location.hash.substring(1) : null;
    if (hash) {
        const target = document.getElementById(hash);
        if (target) {
            target.scrollIntoView({ behavior: 'smooth', block: 'start' });
        }
    }
});
</script>
{% endblock %}
