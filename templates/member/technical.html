{% extends "base.html" %}

{% block title %}App-Einstellungen - Gourmen{% endblock %}

{% block content %}
<div class="container">
    <!-- Breadcrumbs -->
    <nav class="breadcrumbs" aria-label="Breadcrumb">
        <div class="breadcrumbs__item">
            <a href="{{ url_for('member.index') }}" class="breadcrumbs__link">Member</a>
            <span class="breadcrumbs__separator">/</span>
        </div>
        <div class="breadcrumbs__item">
            <span class="breadcrumbs__current">Technische Einstellungen</span>
        </div>
    </nav>

    <div class="page-header">
        <h1>
            <svg class="icon" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                <path d="M10.325 4.317a4.13 4.13 0 0 1 3.35 0l.45.2a4.13 4.13 0 0 0 3.893-.376l.05-.034a4.13 4.13 0 0 1 5.734 1.2 4.13 4.13 0 0 1-1.2 5.734l-.05.034a4.13 4.13 0 0 0-1.743 3.682l.033.5a4.13 4.13 0 0 1-3.993 4.367 4.13 4.13 0 0 1-1.741-.367l-.45-.2a4.13 4.13 0 0 0-3.35 0l-.45.2a4.13 4.13 0 0 1-3.893-.376l-.05-.034a4.13 4.13 0 0 0-5.734 1.2 4.13 4.13 0 0 0 1.2 5.734l.05.034a4.13 4.13 0 0 1 1.743 3.682l-.033.5"/>
                <path d="M12 15a3 3 0 1 0 0-6 3 3 0 0 0 0 6z"/>
            </svg>
            App-Einstellungen
        </h1>
        <p class="page-subtitle">Service Worker und Push-Benachrichtigungen</p>
    </div>
    
    <div class="page-content">
        <!-- Service Worker & Status Card -->
        <div class="card">
            <div class="card__header">
                <h2 class="card__title">
                    <svg class="icon" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                        <path d="M10.325 4.317a4.13 4.13 0 0 1 3.35 0l.45.2a4.13 4.13 0 0 0 3.893-.376l.05-.034a4.13 4.13 0 0 1 5.734 1.2 4.13 4.13 0 0 1-1.2 5.734l-.05.034a4.13 4.13 0 0 0-1.743 3.682l.033.5a4.13 4.13 0 0 1-3.993 4.367 4.13 4.13 0 0 1-1.741-.367l-.45-.2a4.13 4.13 0 0 0-3.35 0l-.45.2a4.13 4.13 0 0 1-3.893-.376l-.05-.034a4.13 4.13 0 0 0-5.734 1.2 4.13 4.13 0 0 0 1.2 5.734l.05.034a4.13 4.13 0 0 1 1.743 3.682l-.033.5"/>
                        <path d="M12 15a3 3 0 1 0 0-6 3 3 0 0 0 0 6z"/>
                    </svg>
                    Service Worker & App-Status
                </h2>
            </div>
            <div class="card__body">
                <div class="info-row">
                    <span class="info-row__label">App-Version</span>
                    <span class="info-row__value" id="app-version">Prüfe...</span>
                </div>
                <div class="info-row">
                    <span class="info-row__label">Service Worker</span>
                    <span class="info-row__value" id="sw-registration-status">Prüfe...</span>
                </div>
                <div class="info-row">
                    <span class="info-row__label">Scope</span>
                    <span class="info-row__value" id="sw-scope">-</span>
                </div>
                <div class="info-row">
                    <span class="info-row__label">Installiert</span>
                    <span class="info-row__value" id="pwa-installed">Prüfe...</span>
                </div>
                <div class="info-row">
                    <span class="info-row__label">Offline-Modus</span>
                    <span class="info-row__value" id="offline-status">Prüfe...</span>
                </div>
                <div class="info-row">
                    <span class="info-row__label">Cache-Status</span>
                    <span class="info-row__value" id="cache-status">Prüfe...</span>
                </div>
            </div>
            <div class="card__footer">
                <button id="sw-diagnose-btn" class="btn btn--primary">
                    <svg class="icon" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                        <circle cx="12" cy="12" r="10"/>
                        <line x1="12" y1="16" x2="12" y2="12"/>
                        <line x1="12" y1="8" x2="12.01" y2="8"/>
                    </svg>
                    Diagnose anzeigen
                </button>
                <button id="sw-cleanup-btn" class="btn btn--outline">
                    <svg class="icon" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                        <path d="m3 5 2 14h14l2-14H3Z"/>
                        <path d="M16 11a4 4 0 0 1-8 0"/>
                    </svg>
                    App zurücksetzen
                </button>
            </div>
            <div class="card__body">
                <div id="sw-status" class="update-status" style="display: none;">
                    <span class="status-text"></span>
                </div>
            </div>
        </div>
        
        <!-- Push-Benachrichtigungen Card -->
        <div class="card">
            <div class="card__header">
                <h2 class="card__title">
                    <svg class="icon" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                        <path d="M18 8a6 6 0 1 0-12 0c0 7-3 9-3 9h18s-3-2-3-9"/>
                        <path d="M13.73 21a2 2 0 0 1-3.46 0"/>
                    </svg>
                    Push-Benachrichtigungen
                </h2>
            </div>
            <div class="card__body">
                <div id="push-enabled-message" style="display: none;">
                    <div class="alert alert--success">
                        <div class="alert__content">
                            <div class="alert__title">Push-Benachrichtigungen sind aktiviert</div>
                            <div class="alert__message">
                                Du erhältst Benachrichtigungen für:
                                <ul style="margin: var(--space-2) 0 0 var(--space-4);">
                                    <li>3-Wochen-Reminder vor Events (Organisatoren)</li>
                                    <li>Montag-Reminder für Teilnehmer</li>
                                    <li>Rating-Erinnerungen nach Events</li>
                                    <li>RSVP-Erinnerungen vom Organisator</li>
                                </ul>
                            </div>
                        </div>
                    </div>
                </div>
                
                <div id="push-disabled-message" style="display: none;">
                    <div class="alert alert--warning">
                        <div class="alert__content">
                            <div class="alert__title">Push-Benachrichtigungen sind nicht aktiviert</div>
                            <div class="alert__message">Du verpasst wichtige Event-Erinnerungen! Aktiviere jetzt Push-Benachrichtigungen.</div>
                        </div>
                    </div>
                </div>
                
                <p class="card-description">
                    Aktiviere Push-Benachrichtigungen, um über neue Events und wichtige Informationen informiert zu werden.
                </p>
                
                <div class="info-row">
                    <span class="info-row__label">Status</span>
                    <span class="info-row__value" id="notification-status">Prüfe...</span>
                </div>
                <div class="info-row">
                    <span class="info-row__label">Berechtigung</span>
                    <span class="info-row__value" id="permission-status">Prüfe...</span>
                </div>
                <div class="info-row">
                    <span class="info-row__label">Push-Support</span>
                    <span class="info-row__value" id="push-status">Prüfe...</span>
                </div>
            </div>
            <div class="card__footer">
                <button id="enable-push-btn" class="btn btn--primary" style="display: none;">
                    <svg class="icon" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                        <path d="M18 8a6 6 0 1 0-12 0c0 7-3 9-3 9h18s-3-2-3-9"/>
                        <path d="M13.73 21a2 2 0 0 1-3.46 0"/>
                    </svg>
                    Benachrichtigungen aktivieren
                </button>
                <button id="sw-test-btn" class="btn btn--outline">
                    <svg class="icon" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                        <path d="M9 18V5l12-2v13"/>
                        <path d="M9 9l12-2"/>
                        <path d="M5 6v12"/>
                        <path d="M3 6h4"/>
                        <path d="M3 18h4"/>
                    </svg>
                    Test-Push senden
                </button>
            </div>
        </div>
        
<script>
document.addEventListener('DOMContentLoaded', function() {
    console.log('⚙️ App-Einstellungen initialisiert');
    
    // Warte auf PWA Initialisierung
    const waitForPWA = setInterval(() => {
        if (window.gourmenPWA) {
            clearInterval(waitForPWA);
            initializePage();
        }
    }, 100);
    
    function initializePage() {
        console.log('✅ PWA geladen');
        
        // Service Worker Info wird automatisch von pwa.js befüllt:
        // - app-version
        // - sw-registration-status  
        // - sw-scope
        // - push-status
        // (siehe pwa.js → setupServiceWorkerInfoCard() → updateServiceWorkerInfo())
        
        // Event Listeners werden von pwa.js gesetzt:
        // - sw-diagnose-btn → performServiceWorkerDiagnosis()
        // - sw-test-btn → testPushNotification()
        // - sw-cleanup-btn → cleanupServiceWorker()
        // - enable-push-btn → wird von app.js gesetzt
        
        // Initiale Status-Updates
        updatePWAStatus();
        updatePushStatus();
        updateCacheStatus();
        
        // Auto-Update alle 5 Sekunden
        setInterval(() => {
            updatePWAStatus();
            updatePushStatus();
            updateCacheStatus();
        }, 5000);
        
        // Online/Offline Events
        window.addEventListener('online', updatePWAStatus);
        window.addEventListener('offline', updatePWAStatus);
    }
    
    // PWA-Status aktualisieren
    function updatePWAStatus() {
        const installedSpan = document.getElementById('pwa-installed');
        if (installedSpan) {
            const isStandalone = window.matchMedia('(display-mode: standalone)').matches || 
                               window.navigator.standalone === true;
            installedSpan.textContent = isStandalone ? 'Ja' : 'Nein';
            installedSpan.className = isStandalone ? 'status-available' : 'status-browser';
        }
        
        const offlineSpan = document.getElementById('offline-status');
        if (offlineSpan) {
            offlineSpan.textContent = navigator.onLine ? 'Aktiviert' : 'Offline';
            offlineSpan.className = navigator.onLine ? 'status-available' : 'status-warning';
        }
    }
    
    // Push-Status aktualisieren
    async function updatePushStatus() {
        const notificationSpan = document.getElementById('notification-status');
        const permissionSpan = document.getElementById('permission-status');
        const enabledMessage = document.getElementById('push-enabled-message');
        const disabledMessage = document.getElementById('push-disabled-message');
        const enableBtn = document.getElementById('enable-push-btn');
        
        if ('Notification' in window) {
            if (notificationSpan) {
                notificationSpan.textContent = 'Verfügbar';
                notificationSpan.className = 'status-available';
            }
            if (permissionSpan) {
                const permission = Notification.permission;
                permissionSpan.textContent = permission === 'granted' ? 'Erteilt' : 
                                           permission === 'denied' ? 'Verweigert' : 'Nicht erteilt';
                permissionSpan.className = permission === 'granted' ? 'status-available' : 
                                          permission === 'denied' ? 'status-unavailable' : 'status-warning';
            }
        } else {
            if (notificationSpan) {
                notificationSpan.textContent = 'Nicht unterstützt';
                notificationSpan.className = 'status-unavailable';
            }
        }
        
        // Prüfe Subscription-Status auf dem Server
        try {
            const response = await fetch('/notifications/push/status');
            const data = await response.json();
            
            if (data.subscribed) {
                // User hat Push aktiviert
                if (enabledMessage) enabledMessage.style.display = 'block';
                if (disabledMessage) disabledMessage.style.display = 'none';
                if (enableBtn) enableBtn.style.display = 'none';
            } else {
                // User hat Push NICHT aktiviert
                if (enabledMessage) enabledMessage.style.display = 'none';
                if (disabledMessage) disabledMessage.style.display = 'block';
                if (enableBtn) enableBtn.style.display = 'inline-block';
            }
        } catch (error) {
            console.error('Error checking push status:', error);
        }
    }
    
    // Cache-Status prüfen
    async function updateCacheStatus() {
        const cacheSpan = document.getElementById('cache-status');
        if (!cacheSpan) return;
        
        try {
            const cacheNames = await caches.keys();
            cacheSpan.textContent = cacheNames.length > 0 ? `${cacheNames.length} aktiv` : 'Keine';
            cacheSpan.className = cacheNames.length > 0 ? 'status-available' : 'status-browser';
        } catch (error) {
            cacheSpan.textContent = 'Fehler';
            cacheSpan.className = 'status-unavailable';
        }
    }
});
</script>
{% endblock %}

