{% extends "base.html" %}

{% block title %}App-Einstellungen - Gourmen{% endblock %}

{% block content %}
<style>
.alert {
    padding: 16px;
    border-radius: 8px;
    margin-bottom: 20px;
}

.alert-success {
    background: linear-gradient(135deg, #11998e 0%, #38ef7d 100%);
    color: white;
}

.alert-warning {
    background: linear-gradient(135deg, #f093fb 0%, #f5576c 100%);
    color: white;
}

.alert strong {
    display: block;
    font-size: 16px;
    margin-bottom: 8px;
}

.alert p {
    margin: 8px 0;
    font-size: 14px;
}

.alert ul {
    margin: 12px 0 0 0;
    padding-left: 24px;
    font-size: 14px;
}

.alert li {
    margin: 4px 0;
}
</style>
<div class="container">
    <!-- Breadcrumbs -->
    <nav class="breadcrumbs" aria-label="Breadcrumb">
        <div class="breadcrumbs__item">
            <a href="{{ url_for('member.index') }}" class="breadcrumbs__link">Member</a>
            <span class="breadcrumbs__separator">/</span>
        </div>
        <div class="breadcrumbs__item">
            <span class="breadcrumbs__current">Technische Einstellungen</span>
        </div>
    </nav>

    <div class="page-header">
        <h1>‚öôÔ∏è App-Einstellungen</h1>
        <p class="page-subtitle">Service Worker und Push-Benachrichtigungen</p>
    </div>
    
    <div class="page-content">
        <!-- Service Worker & Status Card -->
        <div class="card">
            <div class="card-header">
                <h2>üîß Service Worker & App-Status</h2>
                    </div>
                    <div class="card-body">
                        <div class="app-info">
                    <p><strong>App-Version:</strong> <span id="app-version">Pr√ºfe...</span></p>
                    <p><strong>Service Worker:</strong> <span id="sw-registration-status">Pr√ºfe...</span></p>
                            <p><strong>Scope:</strong> <span id="sw-scope">-</span></p>
                    <p><strong>Installiert:</strong> <span id="pwa-installed">Pr√ºfe...</span></p>
                    <p><strong>Offline-Modus:</strong> <span id="offline-status">Pr√ºfe...</span></p>
                    <p><strong>Cache-Status:</strong> <span id="cache-status">Pr√ºfe...</span></p>
                        </div>
                        
                        <div class="card-actions primary">
                            <button id="sw-diagnose-btn" class="btn btn-info">
                                <span class="btn-icon">üîç</span>
                        <span class="btn-text">Diagnose anzeigen</span>
                            </button>
                    <button id="sw-cleanup-btn" class="btn btn-outline">
                        <span class="btn-icon">üßπ</span>
                        <span class="btn-text">App zur√ºcksetzen</span>
                            </button>
                        </div>
                
                <div id="sw-status" class="update-status" style="display: none;">
                    <span class="status-text"></span>
                </div>
            </div>
        </div>
        
        <!-- Push-Benachrichtigungen Card -->
        <div class="card">
            <div class="card-header">
                <h2>üîî Push-Benachrichtigungen</h2>
            </div>
            <div class="card-body">
                <div id="push-enabled-message" style="display: none;">
                    <div class="alert alert-success">
                        <strong>‚úÖ Push-Benachrichtigungen sind aktiviert!</strong>
                        <p>Du erh√§ltst Benachrichtigungen f√ºr:</p>
                        <ul>
                            <li>üìÖ 3-Wochen-Reminder vor Events (nur Organisatoren)</li>
                            <li>ü•∞ Montag-Reminder f√ºr Teilnehmer</li>
                            <li>‚≠ê Rating-Erinnerungen nach Events</li>
                            <li>üîî RSVP-Erinnerungen vom Organisator</li>
                        </ul>
                    </div>
                </div>
                
                <div id="push-disabled-message" style="display: none;">
                    <div class="alert alert-warning">
                        <strong>‚ö†Ô∏è Push-Benachrichtigungen sind nicht aktiviert</strong>
                        <p>Du verpasst wichtige Event-Erinnerungen! Aktiviere jetzt Push-Benachrichtigungen.</p>
                    </div>
                </div>
                
                <p class="card-description">
                    Aktiviere Push-Benachrichtigungen, um √ºber neue Events und wichtige Informationen informiert zu werden.
                </p>
                
                <div class="app-info">
                    <p><strong>Status:</strong> <span id="notification-status">Pr√ºfe...</span></p>
                    <p><strong>Berechtigung:</strong> <span id="permission-status">Pr√ºfe...</span></p>
                    <p><strong>Push-Support:</strong> <span id="push-status">Pr√ºfe...</span></p>
                        </div>
                        
                        <div class="card-actions primary">
                            <button id="enable-push-btn" class="btn btn-primary" style="display: none;">
                                <span class="btn-icon">üîî</span>
                                <span class="btn-text">Benachrichtigungen aktivieren</span>
                            </button>
                    <button id="sw-test-btn" class="btn btn-outline">
                                <span class="btn-icon">üß™</span>
                        <span class="btn-text">Test-Push senden</span>
                            </button>
                        </div>
                    </div>
                </div>
            </div>
        </div>
        
<script>
document.addEventListener('DOMContentLoaded', function() {
    console.log('‚öôÔ∏è App-Einstellungen initialisiert');
    
    // Warte auf PWA Initialisierung
    const waitForPWA = setInterval(() => {
        if (window.gourmenPWA) {
            clearInterval(waitForPWA);
            initializePage();
        }
    }, 100);
    
    function initializePage() {
        console.log('‚úÖ PWA geladen');
        
        // Service Worker Info wird automatisch von pwa.js bef√ºllt:
        // - app-version
        // - sw-registration-status  
        // - sw-scope
        // - push-status
        // (siehe pwa.js ‚Üí setupServiceWorkerInfoCard() ‚Üí updateServiceWorkerInfo())
        
        // Event Listeners werden von pwa.js gesetzt:
        // - sw-diagnose-btn ‚Üí performServiceWorkerDiagnosis()
        // - sw-test-btn ‚Üí testPushNotification()
        // - sw-cleanup-btn ‚Üí cleanupServiceWorker()
        // - enable-push-btn ‚Üí wird von app.js gesetzt
        
        // Initiale Status-Updates
        updatePWAStatus();
        updatePushStatus();
        updateCacheStatus();
        
        // Auto-Update alle 5 Sekunden
        setInterval(() => {
            updatePWAStatus();
            updatePushStatus();
            updateCacheStatus();
        }, 5000);
        
        // Online/Offline Events
        window.addEventListener('online', updatePWAStatus);
        window.addEventListener('offline', updatePWAStatus);
    }
    
    // PWA-Status aktualisieren
    function updatePWAStatus() {
        const installedSpan = document.getElementById('pwa-installed');
        if (installedSpan) {
            const isStandalone = window.matchMedia('(display-mode: standalone)').matches || 
                               window.navigator.standalone === true;
            installedSpan.textContent = isStandalone ? 'Ja' : 'Nein';
            installedSpan.className = isStandalone ? 'status-available' : 'status-browser';
        }
        
        const offlineSpan = document.getElementById('offline-status');
        if (offlineSpan) {
            offlineSpan.textContent = navigator.onLine ? 'Aktiviert' : 'Offline';
            offlineSpan.className = navigator.onLine ? 'status-available' : 'status-warning';
        }
    }
    
    // Push-Status aktualisieren
    async function updatePushStatus() {
        const notificationSpan = document.getElementById('notification-status');
        const permissionSpan = document.getElementById('permission-status');
        const enabledMessage = document.getElementById('push-enabled-message');
        const disabledMessage = document.getElementById('push-disabled-message');
        const enableBtn = document.getElementById('enable-push-btn');
        
        if ('Notification' in window) {
            if (notificationSpan) {
                notificationSpan.textContent = 'Verf√ºgbar';
                notificationSpan.className = 'status-available';
            }
            if (permissionSpan) {
                const permission = Notification.permission;
                permissionSpan.textContent = permission === 'granted' ? 'Erteilt' : 
                                           permission === 'denied' ? 'Verweigert' : 'Nicht erteilt';
                permissionSpan.className = permission === 'granted' ? 'status-available' : 
                                          permission === 'denied' ? 'status-unavailable' : 'status-warning';
            }
        } else {
            if (notificationSpan) {
                notificationSpan.textContent = 'Nicht unterst√ºtzt';
                notificationSpan.className = 'status-unavailable';
            }
        }
        
        // Pr√ºfe Subscription-Status auf dem Server
        try {
            const response = await fetch('/notifications/push/status');
            const data = await response.json();
            
            if (data.subscribed) {
                // User hat Push aktiviert
                if (enabledMessage) enabledMessage.style.display = 'block';
                if (disabledMessage) disabledMessage.style.display = 'none';
                if (enableBtn) enableBtn.style.display = 'none';
            } else {
                // User hat Push NICHT aktiviert
                if (enabledMessage) enabledMessage.style.display = 'none';
                if (disabledMessage) disabledMessage.style.display = 'block';
                if (enableBtn) enableBtn.style.display = 'inline-block';
            }
        } catch (error) {
            console.error('Error checking push status:', error);
        }
    }
    
    // Cache-Status pr√ºfen
    async function updateCacheStatus() {
        const cacheSpan = document.getElementById('cache-status');
        if (!cacheSpan) return;
        
        try {
            const cacheNames = await caches.keys();
            cacheSpan.textContent = cacheNames.length > 0 ? `${cacheNames.length} aktiv` : 'Keine';
            cacheSpan.className = cacheNames.length > 0 ? 'status-available' : 'status-browser';
        } catch (error) {
            cacheSpan.textContent = 'Fehler';
            cacheSpan.className = 'status-unavailable';
        }
    }
});
</script>
{% endblock %}

