{% extends "base.html" %}

{% block title %}App-Einstellungen - Gourmen{% endblock %}

{% block content %}
<div class="container">
    <div class="page-header">
        <h1>âš™ï¸ App-Einstellungen</h1>
        <p class="page-subtitle">Service Worker und Push-Benachrichtigungen</p>
        <div class="page-actions">
            <a href="{{ url_for('member.index') }}" class="btn btn-outline">â† ZurÃ¼ck zur Ãœbersicht</a>
        </div>
    </div>
    
    <div class="page-content">
        <!-- Service Worker & Status Card -->
        <div class="card">
            <div class="card-header">
                <h2>ğŸ”§ Service Worker & App-Status</h2>
            </div>
            <div class="card-body">
                <div class="app-info">
                    <p><strong>App-Version:</strong> <span id="app-version">PrÃ¼fe...</span></p>
                    <p><strong>Service Worker:</strong> <span id="sw-registration-status">PrÃ¼fe...</span></p>
                    <p><strong>Scope:</strong> <span id="sw-scope">-</span></p>
                    <p><strong>Installiert:</strong> <span id="pwa-installed">PrÃ¼fe...</span></p>
                    <p><strong>Offline-Modus:</strong> <span id="offline-status">PrÃ¼fe...</span></p>
                    <p><strong>Cache-Status:</strong> <span id="cache-status">PrÃ¼fe...</span></p>
                </div>
                
                <div class="card-actions primary">
                    <button id="sw-diagnose-btn" class="btn btn-info">
                        <span class="btn-icon">ğŸ”</span>
                        <span class="btn-text">Diagnose anzeigen</span>
                    </button>
                    <button id="sw-cleanup-btn" class="btn btn-outline">
                        <span class="btn-icon">ğŸ§¹</span>
                        <span class="btn-text">App zurÃ¼cksetzen</span>
                    </button>
                </div>
                
                <div id="sw-status" class="update-status" style="display: none;">
                    <span class="status-text"></span>
                </div>
            </div>
        </div>
        
        <!-- Push-Benachrichtigungen Card -->
        <div class="card">
            <div class="card-header">
                <h2>ğŸ”” Push-Benachrichtigungen</h2>
            </div>
            <div class="card-body">
                <p class="card-description">
                    Aktiviere Push-Benachrichtigungen, um Ã¼ber neue Events und wichtige Informationen informiert zu werden.
                </p>
                
                <div class="app-info">
                    <p><strong>Status:</strong> <span id="notification-status">PrÃ¼fe...</span></p>
                    <p><strong>Berechtigung:</strong> <span id="permission-status">PrÃ¼fe...</span></p>
                    <p><strong>Push-Support:</strong> <span id="push-status">PrÃ¼fe...</span></p>
                </div>
                
                <div class="card-actions primary">
                    <button id="enable-push-btn" class="btn btn-primary">
                        <span class="btn-icon">ğŸ””</span>
                        <span class="btn-text">Benachrichtigungen aktivieren</span>
                    </button>
                    <button id="sw-test-btn" class="btn btn-outline">
                        <span class="btn-icon">ğŸ§ª</span>
                        <span class="btn-text">Test-Push senden</span>
                    </button>
                </div>
            </div>
        </div>
    </div>
</div>

<script>
document.addEventListener('DOMContentLoaded', function() {
    console.log('âš™ï¸ App-Einstellungen initialisiert');
    
    // Warte auf PWA Initialisierung
    const waitForPWA = setInterval(() => {
        if (window.gourmenPWA) {
            clearInterval(waitForPWA);
            initializePage();
        }
    }, 100);
    
    function initializePage() {
        console.log('âœ… PWA geladen');
        
        // Service Worker Info wird automatisch von pwa.js befÃ¼llt:
        // - app-version
        // - sw-registration-status  
        // - sw-scope
        // - push-status
        // (siehe pwa.js â†’ setupServiceWorkerInfoCard() â†’ updateServiceWorkerInfo())
        
        // Event Listeners werden von pwa.js gesetzt:
        // - sw-diagnose-btn â†’ performServiceWorkerDiagnosis()
        // - sw-test-btn â†’ testPushNotification()
        // - sw-cleanup-btn â†’ cleanupServiceWorker()
        // - enable-push-btn â†’ wird von app.js gesetzt
        
        // Initiale Status-Updates
        updatePWAStatus();
        updatePushStatus();
        updateCacheStatus();
        
        // Auto-Update alle 5 Sekunden
        setInterval(() => {
            updatePWAStatus();
            updatePushStatus();
            updateCacheStatus();
        }, 5000);
        
        // Online/Offline Events
        window.addEventListener('online', updatePWAStatus);
        window.addEventListener('offline', updatePWAStatus);
    }
    
    // PWA-Status aktualisieren
    function updatePWAStatus() {
        const installedSpan = document.getElementById('pwa-installed');
        if (installedSpan) {
            const isStandalone = window.matchMedia('(display-mode: standalone)').matches || 
                               window.navigator.standalone === true;
            installedSpan.textContent = isStandalone ? 'Ja' : 'Nein';
            installedSpan.className = isStandalone ? 'status-available' : 'status-browser';
        }
        
        const offlineSpan = document.getElementById('offline-status');
        if (offlineSpan) {
            offlineSpan.textContent = navigator.onLine ? 'Aktiviert' : 'Offline';
            offlineSpan.className = navigator.onLine ? 'status-available' : 'status-warning';
        }
    }
    
    // Push-Status aktualisieren
    function updatePushStatus() {
        const notificationSpan = document.getElementById('notification-status');
        const permissionSpan = document.getElementById('permission-status');
        
        if ('Notification' in window) {
            if (notificationSpan) {
                notificationSpan.textContent = 'VerfÃ¼gbar';
                notificationSpan.className = 'status-available';
            }
            if (permissionSpan) {
                const permission = Notification.permission;
                permissionSpan.textContent = permission === 'granted' ? 'Erteilt' : 
                                           permission === 'denied' ? 'Verweigert' : 'Nicht erteilt';
                permissionSpan.className = permission === 'granted' ? 'status-available' : 
                                          permission === 'denied' ? 'status-unavailable' : 'status-warning';
            }
        } else {
            if (notificationSpan) {
                notificationSpan.textContent = 'Nicht unterstÃ¼tzt';
                notificationSpan.className = 'status-unavailable';
            }
        }
    }
    
    // Cache-Status prÃ¼fen
    async function updateCacheStatus() {
        const cacheSpan = document.getElementById('cache-status');
        if (!cacheSpan) return;
        
        try {
            const cacheNames = await caches.keys();
            cacheSpan.textContent = cacheNames.length > 0 ? `${cacheNames.length} aktiv` : 'Keine';
            cacheSpan.className = cacheNames.length > 0 ? 'status-available' : 'status-browser';
        } catch (error) {
            cacheSpan.textContent = 'Fehler';
            cacheSpan.className = 'status-unavailable';
        }
    }
});
</script>
{% endblock %}

