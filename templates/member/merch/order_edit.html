{% extends "base.html" %}

{% block title %}Bestellung bearbeiten - Gourmen{% endblock %}

{% block content %}
<div class="container">
    <nav class="breadcrumbs" aria-label="Breadcrumb">
        <div class="breadcrumbs__item">
            <a href="{{ url_for('member.index') }}" class="breadcrumbs__link">Member</a>
            <span class="breadcrumbs__separator">/</span>
        </div>
        <div class="breadcrumbs__item">
            <a href="{{ url_for('member.merch') }}" class="breadcrumbs__link">Merch</a>
            <span class="breadcrumbs__separator">/</span>
        </div>
        <div class="breadcrumbs__item">
            <a href="{{ url_for('member.merch_order_detail', order_id=order.id) }}" class="breadcrumbs__link">Bestellung</a>
            <span class="breadcrumbs__separator">/</span>
        </div>
        <div class="breadcrumbs__item">
            <span class="breadcrumbs__current">Bearbeiten</span>
        </div>
    </nav>

    <div class="page-header">
        <h1>
            <svg class="icon" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                <path d="M20 21v-2a4 4 0 0 0-4-4H8a4 4 0 0 0-4 4v2"/>
                <circle cx="12" cy="7" r="4"/>
            </svg>
            Bestellung bearbeiten
        </h1>
        <p class="page-subtitle">Bestellung #{{ order.order_number }}</p>
        <div class="page-actions">
            <a href="{{ url_for('member.merch_order_detail', order_id=order.id) }}" class="btn btn--outline">
                <svg class="icon" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                    <path d="M15 18l-6-6 6-6"/>
                </svg>
                Abbrechen
            </a>
        </div>
    </div>

    <div class="page-content">
        <form method="POST" action="{{ url_for('member.merch_order_edit', order_id=order.id) }}" class="form" id="merch-order-form">
            <input type="hidden" name="csrf_token" value="{{ csrf_token() }}"/>

            {% if articles %}
                {% for article in articles %}
                <div class="card">
                    <div class="card__header">
                        <h2 class="card__title">{{ article.name }}</h2>
                        <p class="page-subtitle" style="margin: var(--space-2) 0 0 0;">{{ article.description }}</p>
                    </div>
                    <div class="card__body">
                        <div id="variants_container_{{ article.id }}" data-article-id="{{ article.id }}" class="form-row" style="flex-direction: column; gap: var(--space-3);">
                            {% if article.existing_items %}
                                {% for item in article.existing_items %}
                                <div class="form-row variant-row" data-article-id="{{ article.id }}" data-row-index="{{ loop.index0 }}">
                                    <div class="form-field">
                                        <label class="form-field__label">Farbe</label>
                                        <select name="color_{{ article.id }}[]" 
                                                class="form-field__select color-select"
                                                data-article-id="{{ article.id }}"
                                                data-row-index="{{ loop.index0 }}"
                                                data-preselect-color="{{ item.color }}"
                                                data-preselect-size="{{ item.size }}">
                                            <option value="">Farbe wählen</option>
                                            {% for color in article.available_colors %}
                                            <option value="{{ color }}" {% if color == item.color %}selected{% endif %}>{{ color }}</option>
                                            {% endfor %}
                                        </select>
                                    </div>

                                    <div class="form-field">
                                        <label class="form-field__label">Größe</label>
                                        <select name="size_{{ article.id }}[]" 
                                                class="form-field__select size-select"
                                                data-article-id="{{ article.id }}"
                                                data-row-index="{{ loop.index0 }}">
                                            <option value="">Größe wählen</option>
                                            <option value="{{ item.size }}" selected>{{ item.size }}</option>
                                        </select>
                                    </div>

                                    <div class="form-field">
                                        <label class="form-field__label">Anzahl</label>
                                        <input type="number" 
                                               name="quantity_{{ article.id }}[]" 
                                               min="0" 
                                               max="10" 
                                               value="{{ item.quantity }}" 
                                               class="form-field__input quantity-input"
                                               data-article-id="{{ article.id }}"
                                               data-row-index="{{ loop.index0 }}">
                                    </div>

                                    <div class="form-field">
                                        <label class="form-field__label">Preis</label>
                                        <div class="info-row__value price-value">-</div>
                                    </div>
                                </div>
                                {% endfor %}
                            {% else %}
                                <div class="form-row variant-row" data-article-id="{{ article.id }}" data-row-index="0">
                                    <div class="form-field">
                                        <label class="form-field__label">Farbe</label>
                                        <select name="color_{{ article.id }}[]" 
                                                class="form-field__select color-select"
                                                data-article-id="{{ article.id }}"
                                                data-row-index="0">
                                            <option value="">Farbe wählen</option>
                                            {% for color in article.available_colors %}
                                            <option value="{{ color }}">{{ color }}</option>
                                            {% endfor %}
                                        </select>
                                    </div>

                                    <div class="form-field">
                                        <label class="form-field__label">Größe</label>
                                        <select name="size_{{ article.id }}[]" 
                                                class="form-field__select size-select"
                                                data-article-id="{{ article.id }}"
                                                data-row-index="0"
                                                disabled>
                                            <option value="">Zuerst Farbe wählen</option>
                                        </select>
                                    </div>

                                    <div class="form-field">
                                        <label class="form-field__label">Anzahl</label>
                                        <input type="number" 
                                               name="quantity_{{ article.id }}[]" 
                                               min="0" 
                                               max="10" 
                                               value="0" 
                                               class="form-field__input quantity-input"
                                               data-article-id="{{ article.id }}"
                                               data-row-index="0"
                                               disabled>
                                    </div>

                                    <div class="form-field">
                                        <label class="form-field__label">Preis</label>
                                        <div class="info-row__value price-value">-</div>
                                    </div>
                                </div>
                            {% endif %}
                        </div>

                        <div class="card__footer" style="justify-content: flex-start;">
                            <button type="button" 
                                    class="btn btn--outline js-add-variant" 
                                    data-article-id="{{ article.id }}">
                                Weitere Variante hinzufügen
                            </button>
                        </div>
                    </div>
                </div>
                {% endfor %}

                <div class="card">
                    <div class="card__header">
                        <h2 class="card__title">
                            <svg class="icon" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                                <path d="M12 3v18"/>
                                <path d="M17 8H9.5a3.5 3.5 0 0 0 0 7H14a3.5 3.5 0 0 1 0 7H6"/>
                            </svg>
                            Bestellzusammenfassung
                        </h2>
                    </div>
                    <div class="card__body">
                        <div id="order-summary">
                            <div class="info-row">
                                <span class="info-row__label">Ausgewählte Artikel</span>
                                <span class="info-row__value" id="selected-items">0</span>
                            </div>
                            <div class="info-row">
                                <span class="info-row__label">Gesamtbetrag</span>
                                <span class="info-row__value" id="total-price">0.00 CHF</span>
                            </div>
                        </div>
                    </div>
                    <div class="card__footer">
                        <button type="submit" class="btn btn--primary" id="submit-order-btn">
                            Änderungen speichern
                        </button>
                    </div>
                </div>
            {% else %}
                <div class="card">
                    <div class="card__header">
                        <h2 class="card__title">Keine Artikel verfügbar</h2>
                    </div>
                    <div class="card__body">
                        <p>Derzeit sind keine Merch-Artikel verfügbar.</p>
                    </div>
                    <div class="card__footer">
                        <a href="{{ url_for('member.merch_order_detail', order_id=order.id) }}" class="btn btn--outline">
                            <svg class="icon" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                                <path d="M15 18l-6-6 6-6"/>
                            </svg>
                            Zurück zur Bestellung
                        </a>
                    </div>
                </div>
            {% endif %}
        </form>
    </div>
</div>
{% endblock %}

{% block scripts %}
    {{ super() }}
    {% if articles %}
    <script id="merch-order-edit-data" type="application/json">
    {
      "articles": [
        {% for article in articles %}
        {
          "id": {{ article.id }},
          "available_colors": {{ article.available_colors|tojson }},
          "variants": [
            {% for variant in article.variants %}
            {
              "id": {{ variant.id }},
              "color": {{ variant.color|tojson }},
              "size": {{ variant.size|tojson }},
              "price": {{ variant.member_price_rappen }}
            }{% if not loop.last %},{% endif %}
            {% endfor %}
          ],
          "existing_items": [
            {% for item in article.existing_items %}
            {
              "color": {{ item.color|tojson }},
              "size": {{ item.size|tojson }},
              "quantity": {{ item.quantity }}
            }{% if not loop.last %},{% endif %}
            {% endfor %}
          ]
        }{% if not loop.last %},{% endif %}
        {% endfor %}
      ]
    }
    </script>
    <script src="{{ url_for('static', filename='js/v2/merch-order-edit.js') }}?v=2.0.0" defer></script>
    {% endif %}
{% endblock %}

