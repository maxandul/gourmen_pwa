{% extends "base.html" %}

{% block title %}GGL Saison {{ season_year }} - Gourmen Guessing League{% endblock %}

{% block content %}
<div class="container">
  <nav class="breadcrumbs" aria-label="Breadcrumb">
    <div class="breadcrumbs__item">
      <a href="{{ url_for('ggl.index') }}" class="breadcrumbs__link">GGL</a>
      <span class="breadcrumbs__separator">/</span>
    </div>
    <div class="breadcrumbs__item">
      <span class="breadcrumbs__current">Saison {{ season_year }}</span>
    </div>
  </nav>

  <div class="page-header">
    <h1>
      <svg class="icon" aria-hidden="true">
        <use href="/static/icons/lucide-sprite.svg#trophy"></use>
      </svg>
      GGL Saison {{ season_year }}
    </h1>
  </div>

  <div class="page-content">
    <div class="tabs">
      <nav class="tabs__nav" role="tablist">
        <a href="{{ url_for('ggl.season', season_year=season_year, tab='tabelle') }}"
           class="tabs__tab {{ 'tabs__tab--active' if active_tab == 'tabelle' else '' }}"
           role="tab"
           aria-selected="{{ 'true' if active_tab == 'tabelle' else 'false' }}">
          <svg class="icon" aria-hidden="true">
            <use href="/static/icons/lucide-sprite.svg#bar-chart-2"></use>
          </svg>
          Tabelle
        </a>
        <a href="{{ url_for('ggl.season', season_year=season_year, tab='rennen') }}"
           class="tabs__tab {{ 'tabs__tab--active' if active_tab == 'rennen' else '' }}"
           role="tab"
           aria-selected="{{ 'true' if active_tab == 'rennen' else 'false' }}">
          <svg class="icon" aria-hidden="true">
            <use href="/static/icons/lucide-sprite.svg#activity"></use>
          </svg>
          Rennen
        </a>
      </nav>

      <div class="tabs__content">
        <div class="tabs__panel {{ 'tabs__panel--active' if active_tab == 'tabelle' else '' }}" role="tabpanel">
          {% if season_ranking %}
          <div class="ggl-ranking-list">
            {% for entry in season_ranking %}
            {% set rank_class = 'ggl-ranking-item--rank-' ~ entry.rank if entry.rank <= 3 else '' %}
            <div class="card ggl-ranking-card {{ rank_class }} {% if entry.member_id == current_user.id %}ggl-ranking-item--current{% endif %}">
              <div class="card__header">
                <h3 class="card__title">
                  <span class="badge badge--info ggl-ranking-card__badge">
                    {% if entry.rank <= 3 %}
                    <svg class="icon icon--sm" aria-hidden="true">
                      <use href="/static/icons/lucide-sprite.svg#award"></use>
                    </svg>
                    {% endif %}
                    #{{ entry.rank }}
                  </span>
                  {{ entry.member.display_name_with_spirit }}
                </h3>
              </div>
              <div class="card__body">
                <div class="info-row">
                  <span class="info-row__label">Punkte</span>
                  <span class="info-row__value">{{ entry.total_points }}</span>
                </div>
                <div class="info-row">
                  <span class="info-row__label">Events</span>
                  <span class="info-row__value">{{ entry.participation_count }}</span>
                </div>
                <div class="info-row">
                  <span class="info-row__label">⌀ Punkte</span>
                  <span class="info-row__value">{{ "%.1f"|format(entry.avg_points) }}</span>
                </div>
                <div class="info-row">
                  <span class="info-row__label">⊘ Differenz</span>
                  <span class="info-row__value">{{ "%.1f"|format(entry.avg_diff_rappen / 100) }} CHF</span>
                </div>
              </div>
            </div>
            {% endfor %}
          </div>
          {% else %}
          <div class="alert alert--info" role="status">
            <svg class="alert__icon" aria-hidden="true">
              <use href="/static/icons/lucide-sprite.svg#info"></use>
            </svg>
            <div class="alert__content">
              <div class="alert__message">
                Noch keine Daten für Saison {{ season_year }} verfügbar. Sobald BillBro-Events stattfinden, erscheinen hier die Ergebnisse.
              </div>
            </div>
          </div>
          {% endif %}
        </div>

        <div class="tabs__panel {{ 'tabs__panel--active' if active_tab == 'rennen' else '' }}" role="tabpanel">
          {% if progression_data.events|length > 0 %}
          <div class="card">
            <div class="card__header">
              <h2 class="card__title">
                <svg class="icon" aria-hidden="true">
                  <use href="/static/icons/lucide-sprite.svg#activity"></use>
                </svg>
                Performance-Verlauf
              </h2>
            </div>
            <div class="card__body">
              <div class="ggl-chart">
                <div class="ggl-chart__scroll">
                  <div class="ggl-chart__container">
                    <canvas id="ggl-progression-chart" width="400" height="200" aria-label="Punkteverlauf Diagramm" role="img"></canvas>
                  </div>
                  <div id="ggl-chart-labels" class="ggl-chart__labels"></div>
                </div>
              </div>
              <div class="ggl-chart__note">Mobile: Tippe auf eine Linie, um Tooltips zu togglen.</div>
            </div>
          </div>

          <script type="application/json" id="ggl-progression-data">
            {
              "labels": [
                {% for event in progression_data.events %}
                "{{ event.datum.strftime('%b') }}"{% if not loop.last %},{% endif %}
                {% endfor %}
              ],
              "members": {{ progression_data.members|map(attribute='id')|list|tojson }},
              "data": {{ progression_data.progression_data|tojson }},
              "currentUserId": {{ current_user.id }}
            }
          </script>
          <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
          <script src="https://cdn.jsdelivr.net/npm/chartjs-plugin-datalabels@2"></script>
          <script src="{{ url_for('static', filename='js/v2/ggl-season.js') }}?v=2.0.0" defer></script>
          {% else %}
          <div class="alert alert--info" role="status">
            <svg class="alert__icon" aria-hidden="true">
              <use href="/static/icons/lucide-sprite.svg#info"></use>
            </svg>
            <div class="alert__content">
              <div class="alert__message">
                Noch keine Verlaufsdaten für Saison {{ season_year }} verfügbar.
              </div>
            </div>
          </div>
          {% endif %}
        </div>
      </div>
    </div>
  </div>
</div>
{% endblock %}